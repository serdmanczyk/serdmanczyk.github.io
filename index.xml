<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Erdmanczyk.io</title>
    <link>http://serdmanczyk.github.io/</link>
    <description>Recent content on Erdmanczyk.io</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <lastBuildDate>Thu, 10 Mar 2016 17:24:01 -0800</lastBuildDate>
    <atom:link href="http://serdmanczyk.github.io/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Python Oberserver Metaclass</title>
      <link>http://serdmanczyk.github.io/post/2016-03-11-PythonOberserverMetaclass/</link>
      <pubDate>Thu, 10 Mar 2016 17:24:01 -0800</pubDate>
      
      <guid>http://serdmanczyk.github.io/post/2016-03-11-PythonOberserverMetaclass/</guid>
      <description>

&lt;h2 id=&#34;why:eaf9853e2ff62465491e8f49c533cf3b&#34;&gt;Why?&lt;/h2&gt;

&lt;p&gt;Looking back and grimacing at my Master&amp;rsquo;s thesis code written in the halcyon days of graduate school when I had just started learning Python, I thought it would be a rewarding process to try and re-write it using better coding practices.&lt;/p&gt;

&lt;p&gt;I was wrong.&lt;/p&gt;

&lt;p&gt;At first I found a few interesting ways to re-architect the code, but when that dust clear I realized I would just be spending hours re-implementing mundane details.  So I decided to scrap and let the dead horse lay.&lt;/p&gt;

&lt;p&gt;One thing I got out of the endeavor, though, was I crafted a nifty way to implement an observer class in Python using meta-programming techniques.&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;re familiar with the &lt;a href=&#34;http://www.blackwasp.co.uk/gofpatterns.aspx&#34;&gt;gang of four&lt;/a&gt;, you&amp;rsquo;re familiar with the &lt;a href=&#34;http://www.blackwasp.co.uk/Observer.aspx&#34;&gt;observer&lt;/a&gt; pattern.  The basic principle is objects can subscribe to other object&amp;rsquo;s events and when a particular event happens an object can notify its subscribers.&lt;/p&gt;

&lt;p&gt;The thing about gang of four patterns is given different idioms between languages some of the patterns don&amp;rsquo;t translate as gracefully into all languages, or at the least, wouldn&amp;rsquo;t be implemented the same way.  This was a fun endeavor, but I wouldn&amp;rsquo;t reccomend it in the real world.&lt;/p&gt;

&lt;p&gt;Regardless, because meta-programming is interesting and fun I thought this endeavour worth sharing at least as another example of Python meta-class mechanics.&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    Implements the observer patter via a metaclass&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;inspect&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__receive__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;name,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;args,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;kwargs):&lt;/span&gt;
    &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    Method attached to class on class creation used to pass&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    messages to assigned methods.&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;name&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;observers:&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;argspec&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;observers[name][&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;argspec&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;]&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;inargs&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;{arg:kwargs[arg]&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;arg&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;argspec&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;arg&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;kwargs}&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;observers[name][&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;func&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;](self,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;args,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;inargs)&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;Observer&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(type):&lt;/span&gt;
    &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    Observer metaclass.  All inheriting classes will be able to&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    assigne methods to observer particular events via the @observes&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    decorator.  When a message is received via &lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    instance.receive(&amp;quot;message_name&amp;quot;, **parameters) the associated function&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    will be called with the arguments in **parameters that match the functions&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    argspec&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__call__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(cls,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;args,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;kwargs):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;hasattr(cls,&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;observers&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;):&lt;/span&gt;
            &lt;span style=&#34;color: #f8f8f2&#34;&gt;cls&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;receive&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;__receive__&lt;/span&gt;
            &lt;span style=&#34;color: #f8f8f2&#34;&gt;observers&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;{}&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;attr&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;vars(cls)&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;values():&lt;/span&gt;
                &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;hasattr(attr,&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;__observes__&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;):&lt;/span&gt;
                    &lt;span style=&#34;color: #f8f8f2&#34;&gt;spec&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;inspect&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;getargspec(attr)&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;args&lt;/span&gt;
                    &lt;span style=&#34;color: #f8f8f2&#34;&gt;argspec&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;[arg&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;arg&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;spec&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;arg&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;self&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;]&lt;/span&gt;
                    &lt;span style=&#34;color: #f8f8f2&#34;&gt;observers[attr&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;__observes__]&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;func&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;attr,&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;#39;argspec&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;argspec}&lt;/span&gt;
            &lt;span style=&#34;color: #f8f8f2&#34;&gt;cls&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;observers&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;observers&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;super(Observer,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;cls)&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;__call__(&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;args,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;kwargs)&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;observes&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(event):&lt;/span&gt;
    &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    Used to annotate a function with the event it observers.&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    The annotation is lost before class is fully composed, but&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    is held long enough for the metaclass to intercept and &lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    derive the classes observer mapping&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;wrapper&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(func):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;func&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;__observes__&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;event&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;func&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;wrapper&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;Friend&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(metaclass&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;Observer):&lt;/span&gt;
    &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    A simple observer class example&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__init__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;greetings_received&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;[]&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;consolations&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;[]&lt;/span&gt;

    &lt;span style=&#34;color: #a6e22e&#34;&gt;@observes&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;greeting&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;acnkowledge&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;message&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;hi&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;greetings_received&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;append(message)&lt;/span&gt;

    &lt;span style=&#34;color: #a6e22e&#34;&gt;@observes&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;consoling&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;greaving&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;consolation&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;it&amp;#39;ll be alright&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;affirmation&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;pat on the back&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;consolations&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;append((consolation,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;affirmation))&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;__name__&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;__main__&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;ted&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Friend()&lt;/span&gt;

    &lt;span style=&#34;color: #f8f8f2&#34;&gt;ted&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;receive(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;greeting&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;message&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;s&amp;#39;up&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;postscript&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;homie&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;})&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;ted&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;receive(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;consoling&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;consolation&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;chin up mate&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;})&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;ted&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;receive(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;consoling&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;**&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;consolation&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;thing&amp;#39;ll get better&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;affirmation&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;hug&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;})&lt;/span&gt;
    
    &lt;span style=&#34;color: #66d9ef&#34;&gt;print&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(ted&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;greetings_received)&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;print&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(ted&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;consolations)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id=&#34;what-s-happening:eaf9853e2ff62465491e8f49c533cf3b&#34;&gt;What&amp;rsquo;s happening?&lt;/h2&gt;

&lt;p&gt;The functions decorated by &lt;code&gt;observers&lt;/code&gt; are given an attribute marking what
they observe.&lt;/p&gt;

&lt;p&gt;Since &lt;code&gt;Friend&lt;/code&gt;&amp;rsquo;s metaclass is &lt;code&gt;Observer&lt;/code&gt; the &lt;code&gt;Observer&lt;/code&gt; &lt;code&gt;__call__&lt;/code&gt; method intercepts the class creation before &lt;code&gt;Friend&lt;/code&gt;&amp;rsquo;s &lt;code&gt;__init__&lt;/code&gt; method.&lt;/p&gt;

&lt;p&gt;The &lt;code&gt;__call__&lt;/code&gt; method on &lt;code&gt;Observer&lt;/code&gt; finds all functions marked as observers and stores them in a dictionary alongside their parameter specs and adds this dictionary as an attribute to the class.  It then adds a function &lt;code&gt;receive&lt;/code&gt; which is the observers receive method used by communicating classes and function to pass messages.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;__call__&lt;/code&gt; calls &lt;code&gt;Super&lt;/code&gt; with the modified &lt;code&gt;cls&lt;/code&gt;, which invokes &lt;code&gt;Friend&lt;/code&gt;&amp;rsquo;s &lt;code&gt;__init__&lt;/code&gt; method, continuing our normal program.&lt;/p&gt;

&lt;p&gt;Anytime receive is called, it&amp;rsquo;s passed a parameter of message type (as string), and a **splat of the message into function arguments.  The &lt;code&gt;receive&lt;/code&gt; method intelligently maps the message arguments to the functions arg spec, and invokes the mapped receiving function.&lt;/p&gt;

&lt;p&gt;In a real use case the instance generated from Friend would be passed as a subscriber to the object needing to publish state, which would notify Friend when actions happen.  My intention with this class was my parser for XBee messages in my thesis code would notify the handler classes when messages were received, and the observing handlers would route messages accordingly via this pattern.&lt;/p&gt;

&lt;h2 id=&#34;a-square-peg-in-a-round-hole:eaf9853e2ff62465491e8f49c533cf3b&#34;&gt;A Square Peg in a Round Hole&lt;/h2&gt;

&lt;p&gt;One fallacy with this method is that &lt;em&gt;only the first&lt;/em&gt; instance of &lt;code&gt;Friend&lt;/code&gt; will receive messages since &lt;code&gt;__call__&lt;/code&gt; only builds the observing function map on creation of the class, so latter instance&amp;rsquo;s won&amp;rsquo;t get their functions mapped.  There are a couple of solutions to mitigate this, but they call on more code and more rabbit holes to dig down.  At this point I felt the problem further vindicated my hunch that trying to create a generalized meta-class for the observer pattern in Python was fitting a square peg in a round hole.  Nonetheless, it was a fun opportunity to mess with meta-classes and get a better idea of what uses they have.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Notes and Chords using Python</title>
      <link>http://serdmanczyk.github.io/Python_XBee_Sounds_Library/</link>
      <pubDate>Thu, 11 Jun 2015 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/Python_XBee_Sounds_Library/</guid>
      <description>&lt;p&gt;Life events: my wife and I will be closing on a house in a couple days.  Yay!&lt;/p&gt;

&lt;p&gt;Things have moved quick since moving here to Seattle and I&amp;rsquo;ve realized I haven&amp;rsquo;t been as good about posting on this blog.  Just to get content on here, I figured I would share a recent small project I&amp;rsquo;ve been working on.&lt;/p&gt;

&lt;p&gt;In what time I can spare I&amp;rsquo;ve working on an education course for a hackerspace / STEAM education group here in Seattle.  I wanted to model the course after my Masters Thesis work, so one idea was getting youth engaged with using wireless communications.  One tool I thought would aid in engaging youth would be if they could easily program Arduino/XBee boards to play music, even chords on a remote machine.  This also aids given the interrelation of sound and radio communications having wave properties.  The basic idea is that the kids would program Arduino (or similar) microcontrollers to send messages via XBee that are translated on a central computer into music notes.&lt;/p&gt;

&lt;p&gt;I found plenty of existing examples of generating sine waves using numpy, and turning that data into notes with pyaudio.&lt;/p&gt;

&lt;p&gt;These examples didn&amp;rsquo;t suite my situation because they all used blocking calls to play audio.  You issue the command to play a note and can&amp;rsquo;t issue another until the note was finished.  I wanted to stream audio, and update the stream if a new note was entered.  This required a bit more reading into the pyaudio API.  Since this was a bit of effort for me, I figured I would share for others.&lt;/p&gt;

&lt;p&gt;This is just a starting framework that turns a computer keyboard into a music generating keyboard.  Currently it just assigns notes at random, or sequentially (see commented line 29).  Once a key is pressed, it continues to play the same note.  If all notes are assigned, random notes are given to new keys.&lt;/p&gt;

&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #75715e&#34;&gt;#!/usr/bin/python&lt;/span&gt;
&lt;span style=&#34;color: #75715e&#34;&gt;# coding=utf-8&lt;/span&gt;

&lt;span style=&#34;color: #f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;numpy&lt;/span&gt;
&lt;span style=&#34;color: #f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;random&lt;/span&gt;
&lt;span style=&#34;color: #f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;math&lt;/span&gt;
&lt;span style=&#34;color: #f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;copy&lt;/span&gt;
&lt;span style=&#34;color: #f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;pyaudio&lt;/span&gt;
&lt;span style=&#34;color: #f92672&#34;&gt;from&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Tkinter&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;import&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;NoteGen&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(object):&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__init__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;notes&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;range(&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;30&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;70&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;choices&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;list(map(self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;_note,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;notes))&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;possibilities&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;copy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;copy(self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;choices)&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;mapping&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;{}&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__call__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;key,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;float(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;inf&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;note&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;_get(key,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude)&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note:&lt;/span&gt;
            &lt;span style=&#34;color: #f8f8f2&#34;&gt;note&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;_map(key,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude)&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;_map&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;key,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;possibilities:&lt;/span&gt;
            &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;mapping[key]&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;random&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;choice(self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;choices)&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Note(self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;mapping[key],&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude)&lt;/span&gt;

        &lt;span style=&#34;color: #f8f8f2&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;possibilities[&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;]&lt;/span&gt;
        &lt;span style=&#34;color: #75715e&#34;&gt;# n = random.choice(self.possibilities)&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;possibilities&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;remove(n)&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;mapping[key]&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;n&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Note(n,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude)&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;_get&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;key,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;key&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;mapping:&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Note(self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;mapping[key],&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude)&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;_note&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;n):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;math&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;pow(&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;(float(n)&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;49&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;12&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;440&lt;/span&gt;


&lt;span style=&#34;color: #66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;Note&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(object):&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;names&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;[&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;A#/Bf&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;C&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;C#/Df&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;D&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;D#/Ef&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;E&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;F&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;F#/Gf&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;G&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;G#/Af&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;]&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__init__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;440&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;float(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;inf&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;rate&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;44100&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;total_frames&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;rate&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frame_offset&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;0&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;rate&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;rate&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__call__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;frames):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;done:&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;numpy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;zeros(frames,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;float)&lt;/span&gt;

        &lt;span style=&#34;color: #f8f8f2&#34;&gt;factor&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;float(self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;((math&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;pi&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;rate)&lt;/span&gt;
        
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;length&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;(frames&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;frames&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;remaining&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;remaining)&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;sin&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;numpy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;sin((numpy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;arange(length)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frame_offset)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;factor)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;amplitude&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;frames&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;remaining:&lt;/span&gt;
            &lt;span style=&#34;color: #f8f8f2&#34;&gt;sin&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;numpy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;concatenate([sin,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;numpy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;zeros(frames&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;remaining,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;float)])&lt;/span&gt;

        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frame_offset&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;frames&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;sin&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__lt__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;other):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;other&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__eq__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;other):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;other&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt;
    
    &lt;span style=&#34;color: #a6e22e&#34;&gt;@property&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;remaining&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;total_frames&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frame_offset&lt;/span&gt;
    
    &lt;span style=&#34;color: #a6e22e&#34;&gt;@property&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;done&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frame_offset&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;&amp;gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;total_frames&lt;/span&gt;

    &lt;span style=&#34;color: #a6e22e&#34;&gt;@property&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;keynum&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;int((&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;12&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;math&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;log((self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;440&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;),&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;))&lt;/span&gt;  &lt;span style=&#34;color: #f92672&#34;&gt;+&lt;/span&gt;  &lt;span style=&#34;color: #ae81ff&#34;&gt;48&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;%&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;12&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;names[keynum]&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;Chord&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(object):&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__init__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;[]&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;__call__&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;duration):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;len(self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes):&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;numpy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;zeros(duration,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;float)&lt;/span&gt;

        &lt;span style=&#34;color: #f8f8f2&#34;&gt;gen&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;lambda&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note:note(duration)&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;output&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;sum(map(gen,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes))&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;clean()&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;output&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;add_note&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;isinstance(note,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Note):&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;raise&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;ValueError&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Must be of type Note&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt;

        &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;append(note)&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;remove_note&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;not&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;isinstance(note,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Note):&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt;

        &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes:&lt;/span&gt;
            &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;remove(note)&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;clean&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(self):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes:&lt;/span&gt;
            &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;note&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;done:&lt;/span&gt;
                &lt;span style=&#34;color: #f8f8f2&#34;&gt;self&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;remove(note)&lt;/span&gt;


&lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;__name__&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;__main__&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;p&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;pyaudio&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;PyAudio()&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;chord&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Chord()&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;gen&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;NoteGen()&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;callback&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(in_data,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;frame_count,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;time_info,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;status):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;wave&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;chord(frame_count)&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;wave&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;astype(numpy&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;float32)&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;tostring()&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;(data,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;pyaudio&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;paContinue)&lt;/span&gt;

    &lt;span style=&#34;color: #f8f8f2&#34;&gt;stream&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;open(&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;format&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;pyaudio&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;paFloat32,&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;channels&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;rate&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;44100&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;output&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;True,&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;stream_callback&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;callback&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt;

    &lt;span style=&#34;color: #f8f8f2&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;start_stream()&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;keydown&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(event):&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;k&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;gen(event&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;char,&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;chord&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;add_note(k)&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;print&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;[(n&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;name,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;n&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;frequency)&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;n&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;chord&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;notes]&lt;/span&gt;

    &lt;span style=&#34;color: #66d9ef&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color: #a6e22e&#34;&gt;keyup&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;(event):&lt;/span&gt;
        &lt;span style=&#34;color: #66d9ef&#34;&gt;pass&lt;/span&gt;
        &lt;span style=&#34;color: #75715e&#34;&gt;# k = gen(event.char)&lt;/span&gt;
        &lt;span style=&#34;color: #75715e&#34;&gt;# chord.remove_note(k)&lt;/span&gt;
        &lt;span style=&#34;color: #75715e&#34;&gt;# print [n.name for n in chord.notes]&lt;/span&gt;


    &lt;span style=&#34;color: #f8f8f2&#34;&gt;root&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Tk()&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;frame&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;Frame(root,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;width&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;100&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;height&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;100&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;frame&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;bind_all(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;lt;KeyPress&amp;gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;keydown)&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;frame&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;bind_all(&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;lt;KeyRelease&amp;gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;keyup)&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;frame&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;pack()&lt;/span&gt;

    &lt;span style=&#34;color: #f8f8f2&#34;&gt;root&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;mainloop()&lt;/span&gt;

    &lt;span style=&#34;color: #f8f8f2&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;stop_stream()&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;stream&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;close()&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;p&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;terminate()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This is also available on Github as a &lt;a href=&#34;https://gist.github.com/serdmanczyk/5a9389d80db94440cf15&#34;&gt;gist&lt;/a&gt;.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>GardenSpark: Part Three - Make the Internet Pretty</title>
      <link>http://serdmanczyk.github.io/gardenspark/gardenspark-part-three-making-it-pretty/</link>
      <pubDate>Sun, 05 Apr 2015 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/gardenspark/gardenspark-part-three-making-it-pretty/</guid>
      <description>

&lt;pre&gt;
This project is undergoing a revamp.  Stay tuned for updates!
&lt;/pre&gt;

&lt;h2 id=&#34;intro:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Intro&lt;/h2&gt;

&lt;p&gt;It&amp;rsquo;s been a few months since I&amp;rsquo;ve last done work on this project.  I&amp;rsquo;ve been distracted by job interviews, relocating from Charlotte to Seattle, as well as adjusting to a new job and city with my wife and pets.  Not a bad thing to be distracted by!&lt;/p&gt;

&lt;p&gt;Now that we&amp;rsquo;ve settled a bit, I&amp;rsquo;ve been able to get back into the groove.  In the past couple weeks I&amp;rsquo;ve been able to make a number of changes to the cloud portion of my project.  I&amp;rsquo;ve switched to using webhooks to consume sensor data, added Angularjs to the client framework, improved the web interface, added in-page charts, and implemented live data updates.  That&amp;rsquo;s quite a mouthful!&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://gardenspark-evargreen.rhcloud.com/&#34;&gt;
&lt;figure class=&#34;third&#34;&gt;
  &lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/postthree_home.png&#34;&gt;
  &lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/postthree_temphum.png&#34;&gt;
  &lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/postthree_moistlight.png&#34;&gt;
  &lt;figcaption&gt;Screenshots of the new web interface&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;spark-webhooks:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Spark Webhooks!&lt;/h2&gt;

&lt;p&gt;Minor change, but now &lt;a href=&#34;https://www.spark.io/&#34;&gt;Spark&lt;/a&gt; supports webhooks!  What does this mean?  Previously, to consume the data being sent into the cloud from the Spark Core, I needed to subscribe to it and consume it within my server code.  In my case I used a NodeJS implementation of the EventSource object.&lt;/p&gt;

&lt;p&gt;Now, with webhooks, you can format a request you want Spark&amp;rsquo;s servers to execute against a specific web endpoint when your Spark Core publishes an event.  In my case, the core publishes my sensor data, so I could specify Spark&amp;rsquo;s servers to POST the sensor data to the &amp;lsquo;/readings&amp;rsquo; endpoint on my server when data is published.  So, with about 10 minutes refactoring of code, I now had a much more elegant solution to how to get the data onto my server.  Here&amp;rsquo;s the code for my webhook (&lt;a href=&#34;http://docs.spark.io/webhooks/&#34;&gt;more on Spark&amp;rsquo;s webhooks here&lt;/a&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
    &amp;quot;eventName&amp;quot;: &amp;quot;Readings&amp;quot;,
    &amp;quot;url&amp;quot;: &amp;quot;https://gardenspark-evargreen.rhcloud.com/readings&amp;quot;,
    &amp;quot;requestType&amp;quot;: &amp;quot;POST&amp;quot;,
    &amp;quot;headers&amp;quot;: {
        &amp;quot;Content-Type&amp;quot;: &amp;quot;application/json&amp;quot;
    },
    &amp;quot;json&amp;quot;: {
        &amp;quot;magicpasscode&amp;quot; : &amp;quot;XXX___SECRET___XXX&amp;quot;
    },
    &amp;quot;mydevices&amp;quot;: true
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;implementing-angularjs:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Implementing Angularjs&lt;/h2&gt;

&lt;p&gt;That minor change out of the way, the next change I made was transitioning from rendering the web page content server side using &lt;a href=&#34;http://jade-lang.com/&#34;&gt;Jade&lt;/a&gt; to loading it dynamically client side via Angularjs.  Loading data client side has a number of advantages:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Faster page loading (data loads async)&lt;/li&gt;
&lt;li&gt;Less strain on server from rendering&lt;/li&gt;
&lt;li&gt;More dynamic content&lt;/li&gt;
&lt;li&gt;Easier transitioning between different data presentation models (tables, charts, etc.)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;My prime motivation for choosing Angular as a client framework is that it easily binds data between scripts and html elements via explicit two-way bindings.  This removes the complicated (and ugly code generating) step of having to inspect the DOM to update elements every time data updates.&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;re looking to implement Angular yourself I recommend starting with the &lt;a href=&#34;http://www.w3schools.com/angular/default.asp&#34;&gt;w3schools tutorial&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So the process of transitioning to Angularjs was as simple as a couple iterative steps:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Refactor jade templates to remove dependencies on variables&lt;/li&gt;
&lt;li&gt;Implement AngularJS (create app, controllers, etc.)&lt;/li&gt;
&lt;li&gt;Integrate Angular data-binding into templates&lt;/li&gt;
&lt;li&gt;Use Angular to dynamically data

&lt;ul&gt;
&lt;li&gt;Front page with latest reading&lt;/li&gt;
&lt;li&gt;Readings page with query specified start and end data&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;At this point I have this for my angular app code:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;var app = angular.module(&#39;gardenSpark&#39;, [&#39;&#39;]);

app.controller(&#39;readingsController&#39;, function ($scope, $http) {
   $scope.readings = [];
   $scope.endDate = moment()
      .set(&#39;second&#39;, 0)
      .set(&#39;millisecond&#39;, 0)
      .toDate();
   $scope.startDate = moment()
      .subtract(1, &#39;day&#39;)
      .set(&#39;second&#39;, 0)
      .set(&#39;millisecond&#39;, 0)
      .toDate();

   $scope.refresh = function() {
     $http({
         method: &#39;GET&#39;,
         url: &#39;/readings&#39;,
         params : {
            &#39;start&#39; : $scope.startDate.toISOString(),
            &#39;end&#39; : $scope.endDate.toISOString()
         },
         data:&#39;&#39;
     }).success(function(data){
        $scope.readings = data;
     });
   };

   $scope.refresh();
 });

app.controller(&#39;latestController&#39;, function ($scope, $http){
  $scope.reading = {};

     $http.get(&#39;/latest&#39;).success(function(data){
        $scope.reading = data;
     });
});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And these pieces for my web page templates (in jade):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{% raw %} 
div(ng-controller=&amp;quot;latestController&amp;quot;)
	h2 GardenSpark
	pre
		| ---
		|	Timestamp: {{reading.timestamp | date:&#39;medium&#39;}}
		|	Air_Temperature: {{reading.airtemp}}
		|	Soil_Temperature: {{reading.soiltemp}}
		|	Humidity: {{reading.humidity}}
		|	Soil_Moisture: {{reading.soilmoist}}
		|	Light: {{reading.light}}

div(ng-controller=&amp;quot;readingsController&amp;quot;)
	input(type=&amp;quot;datetime-local&amp;quot; ng-model=&amp;quot;startDate&amp;quot;)
	input(type=&amp;quot;datetime-local&amp;quot; ng-model=&amp;quot;endDate&amp;quot;)
	button(ng-click=&amp;quot;refresh()&amp;quot;) refresh
	table
		tr
			th Timestamp
			th Air Temperature
			th Soil Temperature
			th Humidity
			th Soil Moisture
			th Light
		tr(ng-repeat=&amp;quot;reading in readings&amp;quot;)
			td {{reading.timestamp | date:&#39;medium&#39;}}
			td {{reading.airtemp}}
			td {{reading.soiltemp}}
			td {{reading.humidity}}
			td {{reading.soilmoist}}
			td {{reading.light}}
{% endraw %}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now my start date and end date is bound to the datetime picker elements, which make it easy to dynamically modify the period of time of data I&amp;rsquo;m interested in seeing on the page.&lt;/p&gt;

&lt;h2 id=&#34;reducing-and-smoothing-large-data:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Reducing and Smoothing Large Data&lt;/h2&gt;

&lt;p&gt;It was a big desire of mine to chart the data myself using client side javascript libraries.  First step before doing that was implementing an algorithm to perform reduction and smoothing on the server side to both reduce the amount of data being sent as well as lessen the load on the client scripting perfoming the plotting functionality.  I needed to select a filter that would compact-ify large sets of data while still preserving important features.&lt;/p&gt;

&lt;p&gt;I did some research on existing algorithms.  Some options included &lt;a href=&#34;https://github.com/Tom-Alexander/regression-js&#34;&gt;polynomial regressions&lt;/a&gt;, bayesian algorithms, doing computations based on slope for subsets, or just averaging the data.  Polynomial algorithms wouldn&amp;rsquo;t work well, because the nature of the data doesn&amp;rsquo;t necessarily indicate a polynomial process depending on the time interval being interpreted.  A bayesian algorithm might be best due to the data being better modeled as a &lt;a href=&#34;http://en.wikipedia.org/wiki/Markov_process&#34;&gt;markov process&lt;/a&gt;, but I haven&amp;rsquo;t had time to implement an algorithm of that complexity.  For the time being, I&amp;rsquo;ve decided to simply split any large amount of data into 100 equally spaced subsets and then average the subsets.  This is probably the simplest approach, and for a set of evenly spaced data provides a decent view of trends over time.  This reduces the data to a more handle-able size but has drawbacks such as it hides peaks and the averages aren&amp;rsquo;t &amp;lsquo;true&amp;rsquo; when there are gaps in the data.  This will serve for now while the Spark Core can be expected to consistently log data at the same interval.&lt;/p&gt;

&lt;p&gt;To that end, I made the following simple module.  This runs in the order of O(n + k), where n is the number of datapoints and k is the number of dimensions of the data (in the case of this project 6 dimensions: Air Temperature, Soil Temperature, Humidity, Soil Moisture, Light, Time).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;function split(a, n, processor) {
    var len = a.length,out = [], i = 0, c = 0;
    while (i &amp;lt; len) {
        var size = Math.ceil((len - i) / n--);
        processor(a.slice(i, i += size), c++);
    }
};

module.exports = function(readings) {
	if (readings.length &amp;lt; 100) {
		return readings;
	}

	output = [];
	split(readings, 100, function(subset) {
		averaged = {};

		subset.forEach(function (reading, c) {
		    for (var key in reading){
		    	var n;

		        if (key === &amp;quot;timestamp&amp;quot;){
					n = new Date(reading[key]).getTime();
		        } else {
		        	n = Number(reading[key]);
		        }

		        if (key in averaged){
		            var o = averaged[key];

		            averaged[key] = o + ((n-o)/(c+1));
		        }else{
		            averaged[key] = n;
		        }
		    };
		});

		averaged[&#39;timestamp&#39;] = new Date(averaged[&#39;timestamp&#39;]);

		output.push(averaged);
	});

	return output;
};
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;self-made-charts-sorry-plotly:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Self Made Charts! (sorry plotly)&lt;/h2&gt;

&lt;p&gt;This was a big desire of mine.  Plotly was useful, as it was simple to get started and their API made streaming easy (also, it was free).  It&amp;rsquo;s a fantastic platform, but understandably performance begins to decline when plotting large sets of data, and being able to chart configurable subsets of data on-the-fly is also fairly difficult.&lt;/p&gt;

&lt;p&gt;There&amp;rsquo;s a plethora of javascript plotting libraries available now on the web, many of them based on D3.  After trying a couple, I settled on &lt;a href=&#34;https://github.com/n3-charts/line-chart&#34;&gt;n3-charts&lt;/a&gt;] because it works seemlessly with Angular&amp;rsquo;s two-way data binding model, and the visual product appealed to me.  Adding this on top of my existing Angular code was very easy, I first removed my tables and added their linechart objects.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;div(ng-controller=&amp;quot;readingsController&amp;quot;)
    input(type=&amp;quot;datetime-local&amp;quot; ng-model=&amp;quot;startDate&amp;quot;)
    input(type=&amp;quot;datetime-local&amp;quot; ng-model=&amp;quot;endDate&amp;quot;)
    button(ng-click=&amp;quot;refresh()&amp;quot;) refresh
        span(class=&amp;quot;glyphicon glyphicon-leaf&amp;quot;, aria-hidden=&amp;quot;true&amp;quot;)

    linechart(data=&amp;quot;readings&amp;quot; options=&amp;quot;airhumoptions&amp;quot; mode=&amp;quot;&amp;quot; width=&amp;quot;700&amp;quot; height=&amp;quot;400&amp;quot; style=&amp;quot;background-color:white&amp;quot;)
    linechart(data=&amp;quot;readings&amp;quot; options=&amp;quot;moistlightoptions&amp;quot; mode=&amp;quot;&amp;quot; width=&amp;quot;700&amp;quot; height=&amp;quot;400&amp;quot; style=&amp;quot;background-color:white&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I also needed to update my javascript to include the options to set up the charts.  As not to intrude on the application code in my controllers, I added these as constants to the Angular app, then I only needed to import them in the controller code.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;app.constant(&#39;tempHumOptions&#39;, {
  series: [
    {
      y: &amp;quot;airtemp&amp;quot;,
      label: &amp;quot;Air Temperature&amp;quot;,
      color: &amp;quot;#0099FF&amp;quot;,
      axis: &amp;quot;y&amp;quot;,
      type: &amp;quot;line&amp;quot;,
      thickness: &amp;quot;1px&amp;quot;,
      dotSize: 2,
      id: &amp;quot;airtemp&amp;quot;
    },
    {
      y: &amp;quot;soiltemp&amp;quot;,
      axis: &amp;quot;y&amp;quot;,
      label: &amp;quot;Soil Temperature&amp;quot;,
      color: &amp;quot;#009999&amp;quot;,
      type: &amp;quot;line&amp;quot;,
      thickness: &amp;quot;1px&amp;quot;,
      dotSize: 2,
      id: &amp;quot;soiltemp&amp;quot;
    },
    {
      y: &amp;quot;humidity&amp;quot;,
      axis: &amp;quot;y2&amp;quot;,
      label: &amp;quot;Humidity&amp;quot;,
      color: &amp;quot;#6666FF&amp;quot;,
      type: &amp;quot;line&amp;quot;,
      thickness: &amp;quot;1px&amp;quot;,
      dotSize: 2,
      id: &amp;quot;humidity&amp;quot;
    }
  ],
  stacks: [],
  axes: {
    x: {type: &amp;quot;date&amp;quot;, key: &amp;quot;timestamp&amp;quot;},
    y: {type: &amp;quot;linear&amp;quot;, min: 14, max: 25},
    y2: {type: &amp;quot;linear&amp;quot;, min: 0, max:100}
  },
  lineMode: &amp;quot;monotone&amp;quot;,
  tension: 0.7,
  tooltip: {mode: &amp;quot;scrubber&amp;quot;,interpolate:true},
  drawLegend: true,
  drawDots: false,
  columnsHGap: 5
});

app.constant(&#39;moistLightOptions&#39;, {
  series: [
    {
      y: &amp;quot;soilmoist&amp;quot;,
      label: &amp;quot;Soil Moisture&amp;quot;,
      color: &amp;quot;#996633&amp;quot;,
      axis: &amp;quot;y&amp;quot;,
      type: &amp;quot;line&amp;quot;,
      thickness: &amp;quot;1px&amp;quot;,
      dotSize: 2,
      id: &amp;quot;soilmoist&amp;quot;
    },
    {
      y: &amp;quot;light&amp;quot;,
      axis: &amp;quot;y2&amp;quot;,
      label: &amp;quot;Light&amp;quot;,
      color: &amp;quot;#B28F00&amp;quot;,
      type: &amp;quot;line&amp;quot;,
      thickness: &amp;quot;1px&amp;quot;,
      dotSize: 2,
      id: &amp;quot;light&amp;quot;
    }
  ],
  stacks: [],
  axes: {
    x: {type: &amp;quot;date&amp;quot;, key: &amp;quot;timestamp&amp;quot;},
    y: {type: &amp;quot;linear&amp;quot;, min: 1, max: 2},
    y2: {type: &amp;quot;linear&amp;quot;, min: 0, max: 400}
  },
  lineMode: &amp;quot;cardinal-open&amp;quot;,
  tension: 0.7,
  tooltip: {mode: &amp;quot;scrubber&amp;quot;},
  drawLegend: true,
  drawDots: false,
  columnsHGap: 5
});

app.controller(&#39;readingsController&#39;, function ($scope, $http, tempHumOptions, moistLightOptions) {
....
   $scope.airhumoptions = tempHumOptions;
   $scope.moistlightoptions = moistLightOptions;
...
});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All that done, I had fast, visually appealing charts generated on client-side code in my web page with which I can easily update to preview data from different time spans.  w00t!&lt;/p&gt;

&lt;h2 id=&#34;hosting-server-sent-events:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Hosting Server-Sent Events&lt;/h2&gt;

&lt;p&gt;So now I have charts, and my app is constantly receiving data from the core via the Spark Cloud.  Wouldn&amp;rsquo;t it be cool to have the page automatically update as data is recieved?  In the past I used Server-Sent Events to consume data from the Spark Cloud, so now I decided to utilize this on the server side as a way to publish the data live to the web page.  Publishing the data is as simple as modifying my route for getting the latest data to the following:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// routes/latest.js
...
router.get(&#39;/&#39;, function(req,res){
	if (req.query.one == &#39;true&#39;) {
	    db.getLatest(function(data){
			res.end(JSON.stringify(data));
	    });
	    return;
	}

	req.socket.setTimeout(Infinity);

	var genEvent = (function () {
		var messageCount = 0;
		return function(data) {
			var event = [
				&#39;event: newdata&#39;,
				&#39;id: &#39; + messageCount,
				&#39;data: &#39; + JSON.stringify(data),
			].join(&#39;\n&#39;) + &#39;\n\n&#39;;

			messageCount++;
			return event;
		}
	})()

	spewer.on(&#39;data&#39;, function(data){
		res.write(genEvent(data));
    });

    db.getLatest(function(data){
		res.write(genEvent(data));
    });

	res.writeHead(200, {
		&#39;Content-Type&#39;: &#39;text/event-stream&#39;,
		&#39;Cache-Control&#39;: &#39;no-cache&#39;,
		&#39;Connection&#39;: &#39;keep-alive&#39;
	});
	res.write(&#39;\n&#39;);
});

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The code simply sends the appropriate headers, keeps the connection open, then as new data is emitted via &amp;lsquo;spewer&amp;rsquo; (an emitter object) it sends it to the client in the appropriate format.  I generate the function that formats the data via a closure as an elegant way to encapsulate the message count (id) of the events.&lt;/p&gt;

&lt;p&gt;With sending SSE so simple, the main question was how to pipe the data from the receiving portion of the code to the response handling portion.  Some examples will use a separate publish/subscribe system such as &lt;a href=&#34;http://redis.io/&#34;&gt;redis&lt;/a&gt;, but as cool as that would be I thought it be overkill in my case.  That would be more useful in distributed systems, or where the system is optimized for multiple processes and there is a need to pass the information between independent instances (future plans!(maybe)).  In my case, I just needed something quick and clean, and as I improve the server I could easily scale.  I simply created a singleton that subclasses the emitter object, then shared that between the modules that receive and send the data.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;//  spewer.js
&amp;quot;use strict&amp;quot;
var util = require(&#39;util&#39;),
    Emitter = require(&#39;events&#39;).EventEmitter;

var spewer = function spewer(){
    Emitter.call(this);
};

util.inherits(spewer, Emitter)

module.exports = new spewer();

// routes/readings.js
...
router.post(&#39;/&#39;, function(req,res){
    if (req.body.magicpasscode &amp;amp;&amp;amp; req.body.magicpasscode == readings_secret) {
        var readings = JSON.parse(req.body.data),
            sparkData = {
                &amp;quot;timestamp&amp;quot;: req.body.published_at,
                &amp;quot;airtemp&amp;quot;: readings[0],
                &amp;quot;soiltemp&amp;quot;: readings[1],
                &amp;quot;humidity&amp;quot;: readings[2],
                &amp;quot;soilmoist&amp;quot;: readings[3],
                &amp;quot;light&amp;quot;: readings[4]
            };

        spewer.emit(&#39;data&#39;, sparkData);
        db.insert(sparkData);
    }

    res.writeHead(200, {&#39;Content-Type&#39;: &#39;application/json&#39;});
    res.end(&#39;&#39;);
});

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the client side, I just needed to modify my controller to use the html5 EventSource object, which automagically handles connecting, re-connecting, and emitting the data.  I borrowed an angular factory from &lt;a href=&#34;https://github.com/timruffles/chat-event-source&#34;&gt;this example&lt;/a&gt;, that wraps the standard EventSource to apply the handling function within Angular&amp;rsquo;s $scope (&lt;a href=&#34;http://jimhoskins.com/2012/12/17/angularjs-and-apply.html&#34;&gt;more on why, here&lt;/a&gt;).&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// app.js
...
app.factory(&amp;quot;EventSource&amp;quot;, EventSourceNg);

function EventSourceNg($rootScope) {
  function EventSourceNg(url) {
    this.source = new EventSource(url);
  }
  EventSourceNg.prototype = {
    addEventListener: function(x, fn) {
      this.source.addEventListener(x, function(event) {
        $rootScope.$apply(fn.bind(null, event));
      });
    }
  }
  if (typeof(EventSource) !== &amp;quot;undefined&amp;quot;) {
    return EventSourceNg;
  } else {
    return undefined;
  }
};

// controllers.js
...
app.controller(&#39;latestController&#39;, function ($scope, $http, EventSource){
  $scope.reading = {};

  if (typeof(EventSource) !== &amp;quot;undefined&amp;quot;) {
    var dataEvent = new EventSource(&#39;/latest&#39;);

    dataEvent.addEventListener(&#39;newdata&#39;, function(event) {
      $scope.reading = JSON.parse(event.data);
    }, false);
  }
  else {
     $http({
           method: &#39;GET&#39;,
           url: &#39;/latest&#39;,
           params : {
              &#39;one&#39;: &#39;true&#39;,
           },
           data:&#39;&#39;
     }).success(function(data){
        $scope.reading = data;
     });
  }
});
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;presentation-with-reveal-js:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Presentation with reveal.js&lt;/h2&gt;

&lt;p&gt;So now I have all this cool stuff, but my web page was still lacking in terms of overall aesthetics.  There&amp;rsquo;s libraries like &lt;a href=&#34;http://getbootstrap.com/2.3.2/&#34;&gt;Twitter Bootstrap&lt;/a&gt; to simplify getting from zero to useful in interface design, but that&amp;rsquo;s better suited to a more complex interface.  For all the parts of this system, it doesn&amp;rsquo;t really require a complicated interface to present the data it needs.  It needs only present one interface with current data and another interface to visualize historical data.  There&amp;rsquo;s no real need for menus, columns, forms, or anything elaborate.&lt;/p&gt;

&lt;p&gt;All I really wanted was to present my information on a single web page, and allow the user to intuitively navigate between sections of the page.  Enter &amp;lsquo;&lt;a href=&#34;http://lab.hakim.se/reveal-js/&#34;&gt;reveal.js&lt;/a&gt;&amp;rsquo;, a handy framework for building &amp;lsquo;powerpoint&amp;rsquo; presentations using html and javascript.  It&amp;rsquo;s a bit of overkill for what I want, but super simple to use, so implementation cost was fairly low.  I could spend the time to figure out how to write my own custom code to do just what I need, but the time cost was more than I&amp;rsquo;m interested in.&lt;/p&gt;

&lt;p&gt;To make my page use reveal.js I simply combined everything into a single file, split the pages into &amp;lsquo;section&amp;rsquo; elements and included the reveal.js scripts.  Which led to the following refactored jade template for my index page:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;doctype
html(ng-app=&amp;quot;gardenSpark&amp;quot;)
	head
		meta(charset=&amp;quot;utf-8&amp;quot;)

		title GardenSpark

		meta(name=&amp;quot;description&amp;quot; content=&amp;quot;DIY home garden sensor!&amp;quot;)
		meta(name=&amp;quot;author&amp;quot; content=&amp;quot;Steven James Erdmanczyk Jr.&amp;quot;)

		meta(name=&amp;quot;apple-mobile-web-app-capable&amp;quot; content=&amp;quot;yes&amp;quot;)
		meta(name=&amp;quot;apple-mobile-web-app-status-bar-style&amp;quot; content=&amp;quot;black-translucent&amp;quot;)

		meta(name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui&amp;quot;)

		link(rel=&amp;quot;stylesheet&amp;quot; href=&amp;quot;stylesheets/reveal.css&amp;quot;)
		link(rel=&amp;quot;stylesheet&amp;quot; href=&amp;quot;stylesheets/theme/sky.css&amp;quot; id=&amp;quot;theme&amp;quot;)

&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;    &amp;lt;link rel=&amp;quot;stylesheet&amp;quot; href=&amp;quot;stylesheets/zenburn.css&amp;quot;&amp;gt;

    &amp;lt;!--[if lt IE 9]&amp;gt;
    &amp;lt;script src=&amp;quot;lib/js/html5shiv.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
    &amp;lt;![endif]--&amp;gt;
body
    .reveal
        .slides
            section(ng-controller=&amp;quot;latestController&amp;quot;)
                h2 GardenSpark
                pre
                    | ---
                    |   Timestamp: &amp;quot;{{reading.timestamp | date:&#39;medium&#39;}}&amp;quot;
                    |   Air_Temperature: {{reading.airtemp}}
                    |   Soil_Temperature: {{reading.soiltemp}}
                    |   Humidity: {{reading.humidity}}
                    |   Soil_Moisture: {{reading.soilmoist}}
                    |   Light: {{reading.light}}

            section(ng-controller=&amp;quot;readingsController&amp;quot;)
                section
                    h2 Temperature / Humidity
                    input(type=&amp;quot;datetime-local&amp;quot; ng-model=&amp;quot;startDate&amp;quot;)
                    input(type=&amp;quot;datetime-local&amp;quot; ng-model=&amp;quot;endDate&amp;quot;)

                    button(ng-click=&amp;quot;refresh()&amp;quot;) refresh
                        span(class=&amp;quot;glyphicon glyphicon-leaf&amp;quot;, aria-hidden=&amp;quot;true&amp;quot;)
                    linechart(data=&amp;quot;readings&amp;quot; options=&amp;quot;airhumoptions&amp;quot; mode=&amp;quot;&amp;quot; width=&amp;quot;700&amp;quot; height=&amp;quot;400&amp;quot; style=&amp;quot;background-color:white&amp;quot;)

                section
                    h2 Soil Moisture / Light

                    linechart(data=&amp;quot;readings&amp;quot; options=&amp;quot;moistlightoptions&amp;quot; mode=&amp;quot;&amp;quot; width=&amp;quot;700&amp;quot; height=&amp;quot;400&amp;quot; style=&amp;quot;background-color:white&amp;quot;)

    //- script(src=&#39;//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js&#39;)
    //- script(src=&#39;//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js&#39;)
    script(src=&#39;//ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js&#39;)
    script(src=&amp;quot;//d3js.org/d3.v3.min.js&amp;quot; charset=&amp;quot;utf-8&amp;quot;)
    script(src=&#39;/scripts/moment.min.js&#39;)
    script(src=&#39;/scripts/line-chart.min.js&#39;)
    script(src=&#39;/scripts/app.js&#39;)
    script(src=&#39;/scripts/controllers.js&#39;)
    script(src=&amp;quot;scripts/head.min.js&amp;quot;)
    script(src=&amp;quot;scripts/reveal.js&amp;quot;)

    script(type=&#39;text/javascript&#39;).

        // Full list of configuration options available at:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: true,
            progress: true,
            history: true,
            center: true,
            loop: true,

            transition: &#39;convex&#39;, // none/fade/slide/convex/concave/zoom

            // Optional reveal.js plugins
            dependencies: [
                // { src: &#39;lib/js/classList.js&#39;, condition: function() { return !document.body.classList; } },
                // { src: &#39;plugin/markdown/marked.js&#39;, condition: function() { return !!document.querySelector( &#39;[data-markdown]&#39; ); } },
                // { src: &#39;plugin/markdown/markdown.js&#39;, condition: function() { return !!document.querySelector( &#39;[data-markdown]&#39; ); } },
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;					// { src: &#39;plugin/zoom-js/zoom.js&#39;, async: true },
					// { src: &#39;plugin/notes/notes.js&#39;, async: true }
				]
			});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Bam!  I have something pretty.&lt;/p&gt;

&lt;h2 id=&#34;summary:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;I feel like I&amp;rsquo;ve made a lightyear jump from where I was in just a couple weeks time.  This is quite encouraging.  Now my interface is almost at 100% of where I wanted it to be.  Next step will be to update the live preview page to include guages or some sort of visualization mechanism.  Once that&amp;rsquo;s done, I&amp;rsquo;m going to get back into the physical world and work on cooler things such as adding solar power, making a custom PCB, building an enclosure, and implementing an automated watering mechanism.&lt;/p&gt;

&lt;h2 id=&#34;helpful-resources:67cc732d739b2a5cfc6d74f2ffc310d5&#34;&gt;Helpful Resources&lt;/h2&gt;

&lt;p&gt;I used quite a few resources during this phase of the project, so I figured it would be helpful to link them here for other people trying to do the same thing, sort of like a bibliography.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.w3schools.com/angular/default.asp&#34;&gt;Angular tutorial at w3schools&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/timruffles/chat-event-source&#34;&gt;Wrapping EventSource for Angular&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://lab.hakim.se/reveal-js/&#34;&gt;HTML5 presentations using reveal.js&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://stackoverflow.com/a/8189268/2406040&#34;&gt;Slicing a list into N equal size pieces (Javascript)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/Smoothing#Smoothing_algorithms&#34;&gt;Data smoothing algorithms&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/Tom-Alexander/regression-js&#34;&gt;Polynomial (and other) regressions in Javascript (library)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>Moving to Seattle, How&#39;s the Weather? (graphs!)</title>
      <link>http://serdmanczyk.github.io/post/2015-02-12-moving-to-seattle-hows-the-weather/</link>
      <pubDate>Wed, 25 Feb 2015 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/post/2015-02-12-moving-to-seattle-hows-the-weather/</guid>
      <description>&lt;p&gt;My wife and I recently relocated from Charlotte, NC to Seattle, WA and so far we&amp;rsquo;ve loved it!&lt;/p&gt;

&lt;p&gt;One of the most common things people talk about when you mention moving to the Pacific Northwest is the weather, particularly the kind that results in being wet.  The weather here is obviously different, but in my short time here  it hasn&amp;rsquo;t seemed &lt;em&gt;that&lt;/em&gt; different.  Being the scientific type, I went straight to finding objective data to make heads or tails of my impression so far.&lt;/p&gt;

&lt;p&gt;First step was to find some hard weather data.  I wanted historical weather data by date and city, preferably for free.  I was able to find that via &lt;a href=&#34;http://www.wunderground.com/weather/api/d/docs?MR=1&#34;&gt;Weather Underground&amp;rsquo;s API&lt;/a&gt; .  I hacked together a quick python script to grab data for the dates I needed.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import requests
import json
from datetime import datetime,timedelta
import re
import time
import os
import sys
import arrow

APIKEY = &#39;__REDACTED__&#39;

def urliter():
	Locations = [
		(&#39;NC&#39;, &#39;Charlotte&#39;),
		(&#39;WA&#39;, &#39;Seattle&#39;)
	]

	def DateIter(start, end):
	    start = arrow.get(start)
	    end = arrow.get(end)

	    for day in arrow.Arrow.span_range(&#39;day&#39;, start, end):
	        yield day[0]

	for location in Locations:
		for day in DateIter(&#39;2014-11-12&#39;, &#39;2015-02-24&#39;):
			url = &#39;http://api.wunderground.com/api/{key}/history_{year:04d}{month:02d}{day:02d}/q/{state}/{city}.json&#39;.format(**{
				&#39;key&#39;:APIKEY,
				&#39;year&#39;:day.year,
				&#39;month&#39;:day.month,
				&#39;day&#39;:day.day,
				&#39;state&#39;:location[0],
				&#39;city&#39;:location[1],
			})

			directory = location[1]

			filename = &#39;{year:04d}{month:02d}{day:02d}.json&#39;.format(**{
				&#39;year&#39;:day.year,
				&#39;month&#39;:day.month,
				&#39;day&#39;:day.day
			})

			yield (
				directory,
				filename,
				url
			)

for rq in urliter():
	directory,filename,url = rq

	time.sleep(7)
	print(&amp;quot;get:&amp;quot;, url)
	respobj = requests.get(url).json()
	
	dirpath = os.path.abspath(directory)
	if not os.path.exists(dirpath):
		os.makedirs(dirpath)

	filepath = os.path.join(dirpath,filename)
	print(&amp;quot;save:&amp;quot;, filepath)
	with open(filepath, &amp;quot;w&amp;quot;) as opf:
	    json.dump(respobj, opf, indent=3, sort_keys=True)

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That effectively grabbed and organized all the data, and conformed to the rate limit (10 requests / minute).  The next step I took was storing it all in a query-able format, so I turned to my old friend MongoDB.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import json
import os
from math import sqrt,pow
import sys
from pymongo import MongoClient
import arrow

def fileloader(directory):
    adir = os.path.abspath(directory)
    for dirpath, dirnames, filenames in os.walk(adir):
        for filename in filenames:
            filepath = os.path.join(dirpath, filename)
            _,etx = os.path.splitext(filepath)
            if etx == &amp;quot;.json&amp;quot;:
                with open(filepath) as opf:
                    yield filepath, json.load(opf)

locations = (
    (&amp;quot;Seattle&amp;quot;, &amp;quot;WA&amp;quot;),
    (&amp;quot;Charlotte&amp;quot;, &amp;quot;NC&amp;quot;)
)

client = MongoClient()
weatherdata = client.weatherdata

summaries_db = weatherdata.summaries
observations_db = weatherdata.observations

for loc in locations:
    city,state = loc
    for filepath,datapoint in fileloader(city):
        summary = datapoint[&#39;history&#39;][&#39;dailysummary&#39;][0]

        isodate = &amp;quot;{year}-{mon}-{mday}T{hour}:{min}:00.000&amp;quot;.format(**summary[&amp;quot;date&amp;quot;])
        del summary[&amp;quot;date&amp;quot;]

        summary.update({
            &amp;quot;city&amp;quot; : city,
            &amp;quot;state&amp;quot; : state,
            &amp;quot;isodate&amp;quot; : arrow.get(isodate).datetime,
        })

        sum_id = summaries_db.insert(summary)
        # print(&amp;quot;summary&amp;quot;, rec_id)

        observations = datapoint[&#39;history&#39;][&#39;observations&#39;]
        obs_ids = []
        for observation in observations:
            isodt = &amp;quot;{year}-{mon}-{mday}T{hour}:{min}:00.000&amp;quot;.format(**observation[&amp;quot;utcdate&amp;quot;])
            del observation[&amp;quot;date&amp;quot;]
            del observation[&amp;quot;utcdate&amp;quot;]
            observation.update({
                &amp;quot;city&amp;quot; : city,
                &amp;quot;state&amp;quot; : state,
                &amp;quot;isodatetime&amp;quot; : arrow.get(isodt).datetime
            })

            obs_id = observations_db.insert(observation)
            obs_ids.append(obs_id)
        print city, &amp;quot;:&amp;quot;, summary[&#39;isodate&#39;]

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Having it stored in MongoDB made it quick and convenient to query the data and pick apart how to interpret the data into something useful.  I was primarily seeking to represent the general distribution of temperatures, humidities, and intensity/types of precipitation between the two cities.  Eventually, I threw together a script to grab all of that data and throw it into plots using &lt;a href=&#34;https://plot.ly/python/&#34;&gt;plotly&amp;rsquo;s python API&lt;/a&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;from pymongo import MongoClient
import plotly.plotly as py
from plotly.graph_objs import *
import json

client = MongoClient()
weatherdata = client.weatherdata
observations_db = weatherdata.observations
summaries_db = weatherdata.summaries

filters = {
    &#39;_id&#39;:False,
    &#39;isodatetime&#39;:False,
    &#39;isodate&#39;:False,
}

charlotte = observations_db.find({
    &#39;city&#39;:&#39;Charlotte&#39;
},filters)

seattle = observations_db.find({
    &#39;city&#39;:&#39;Seattle&#39;
},filters)

# print(json.dumps(list(sorted(set([c[&#39;conds&#39;] for c in charlotte])))))

def getvals(dataset, params):
    output = tuple([] for _ in params)

    for point in dataset:
        for i,param in enumerate(params):
            key,filt,typ = param
            val = point[key]
            if filt(val):
                output[i].append(typ(val))

    return (output if (len(output) &amp;gt; 1) else output[0])

validtemp = lambda val:val != &amp;quot;-9999&amp;quot;
validhum = lambda val:val != &amp;quot;N/A&amp;quot;
validcond = lambda val:val != &amp;quot;Unknown&amp;quot;

params = (
    (&#39;tempi&#39;, validtemp, float),
    (&#39;hum&#39;, validhum, float),
    (&#39;conds&#39;, validcond, str)
)

clt_temps,clt_hums,clt_conds = getvals(charlotte, params)
sea_temps,sea_hums,sea_conds = getvals(seattle, params)

name = &#39;Charlotte vs. Seattle Temperature&#39;
plot_url = py.plot(
    Figure(
        data = Data([
            Box(
                y = clt_temps,
                name = &#39;Charlotte&#39;,
                jitter = 0.3
            ),
            Box(
                y = sea_temps,
                name = &#39;Seattle&#39;,
                jitter = 0.3
            )
        ]),
        layout = Layout(
            title = name
        )
    ),
    filename = name
)
print(plot_url)

name = &#39;Charlotte vs. Seattle Humidity&#39;
plot_url = py.plot(
    Figure(
        data = Data([
            Box(
                y = clt_hums,
                name = &#39;Charlotte&#39;,
                jitter = 0.3
            ),
            Box(
                y = sea_hums,
                name = &#39;Seattle&#39;,
                jitter = 0.3
            )
        ]),
        layout = Layout(
            title = name
        )
    ),
    filename = name
)
print(plot_url)

intensities = [
  &amp;quot;Heavy Thunderstorms and Rain&amp;quot;,
  &amp;quot;Thunderstorms and Rain&amp;quot;,
  &amp;quot;Heavy Rain&amp;quot;, &amp;quot;Ice Pellets&amp;quot;, &amp;quot;Light Ice Pellets&amp;quot;,
  &amp;quot;Light Freezing Rain&amp;quot;, &amp;quot;Rain&amp;quot;, &amp;quot;Light Rain&amp;quot;,
  &amp;quot;Light Snow&amp;quot;, &amp;quot;Light Freezing Fog&amp;quot;,
  &amp;quot;Drizzle&amp;quot;, &amp;quot;Light Drizzle&amp;quot;, &amp;quot;Mist&amp;quot;,
  &amp;quot;Overcast&amp;quot;, &amp;quot;Fog&amp;quot;, &amp;quot;Haze&amp;quot;,
  &amp;quot;Mostly Cloudy&amp;quot;, &amp;quot;Partly Cloudy&amp;quot;,
  &amp;quot;Scattered Clouds&amp;quot;, &amp;quot;Clear&amp;quot;
]

def countintensities(dataset):
    counts = {}
    for cond in dataset:
        counts[cond] = ((counts[cond]+1) if counts.get(cond) else 1)

    countgetter = lambda val:(counts[val] if val in counts else 0)
    return list(map(countgetter, intensities))

name = &#39;Charlotte vs. Seattle Weather Rain Intensity&#39;
plot_url = py.plot(
    Figure(
        data = Data([
            Bar(
                x = intensities,
                y = countintensities(clt_conds),
                name = &#39;Charlotte&#39;
            ),
            Bar(
                x = intensities,
                y = countintensities(sea_conds),
                name = &#39;Seattle&#39;
            )
        ]),
        layout = Layout(
            barmode=&#39;group&#39;,
            title = name
        )
    ),
    filename = name
)
print(plot_url)

charlotte = summaries_db.find({
    &#39;city&#39;:&#39;Charlotte&#39;
},filters)

seattle = summaries_db.find({
    &#39;city&#39;:&#39;Seattle&#39;
},filters)

validprecip = lambda val:val != &amp;quot;T&amp;quot;

params = (
    (&#39;precipi&#39;, validprecip, float),
)

clt_precip = getvals(charlotte, params)
sea_precip = getvals(seattle, params)

name = &#39;Charlotte vs. Seattle Precipitation&#39;
plot_url = py.plot(
    Figure(
        data = Data([
            Box(
                y = clt_precip,
                name = &#39;Charlotte&#39;,
                jitter = 0.3
            ),
            Box(
                y = sea_precip,
                name = &#39;Seattle&#39;,
                jitter = 0.3
            )
        ]),
        layout = Layout(
            title = name
        )
    ),
    filename = name
)
print(plot_url)

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that weather condition intensity is organized completely based on my own subjective interpretation.
{: .notice}&lt;/p&gt;

&lt;p&gt;The above script gave me the following plots:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/movseaweather/charlotte_vs_seattle_humidity.png&#34; alt=&#34;CharSeaHums&#34; /&gt;
&lt;img src=&#34;http://serdmanczyk.github.io/images/movseaweather/charlotte_vs_seattle_temperature.png&#34; alt=&#34;CharSeaTemps&#34; /&gt;
&lt;img src=&#34;http://serdmanczyk.github.io/images/movseaweather/charlotte_vs_seattle_precipitation.png&#34; alt=&#34;CharSeaPrecip&#34; /&gt;
&lt;img src=&#34;http://serdmanczyk.github.io/images/movseaweather/charlotte_vs_seattle_weather_rain_intensity.png&#34; alt=&#34;CharSeaConds&#34; /&gt;&lt;/p&gt;

&lt;p&gt;All data Powered by Weather Underground &lt;a href=&#34;http://wunderground.com/&#34;&gt;&lt;img height=&#34;45&#34; width=&#34;193&#34; src=&#34;http://serdmanczyk.github.io/images/movseaweather/wundergroundLogo_4c_horz.png&#34;&gt;&lt;/a&gt; as &lt;a href=&#34;http://www.wunderground.com/weather/api/d/terms.html&#34;&gt;per API usage requirements&lt;/a&gt;.
{: .notice}&lt;/p&gt;

&lt;p&gt;The plots pretty much showed me what I expected, that the weather here is milder, more consistent, and though it rains more, when it rains it&amp;rsquo;s usually lighter and more constant than it is in Charlotte (where apparently it can&amp;rsquo;t rain without absolutely pouring).&lt;/p&gt;

&lt;p&gt;But there was another thing I noticed after moving here that isn&amp;rsquo;t mentioned as much.  Having arrived in November I immediately noticed the sun setting nearly an hour earlier, a result of the higher latitude.  I also became curious of how sunrise and sunset times differed for the cities throughout the year.  Calculating sunrise and sunset times only requires performing some &lt;a href=&#34;http://en.wikipedia.org/wiki/Sunrise_equation&#34;&gt;mathematical computations&lt;/a&gt; based on longitude and latitude.  But since I don&amp;rsquo;t have all the time in the world I thought it much easier to google an existing module rather than re-write it from scratch, and came up with the fantastic &lt;a href=&#34;http://pythonhosted.org//astral/&#34;&gt;astral module&lt;/a&gt;.  Using this I threw up a quick script to plot sunrise, sunset, and hours of sunlight:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;import arrow
from astral import Astral
import plotly.plotly as py
from plotly.graph_objs import *
import sys
import math
from dateutil import tz
import pprint

pp = pprint.PrettyPrinter(indent=3)

a = Astral()
a.solar_depression = &#39;civil&#39; 

start = arrow.get(&amp;quot;2014-01-01&amp;quot;)
end = arrow.get(&amp;quot;2014-12-31&amp;quot;)

types = [&#39;sunlight&#39;, &#39;sunrise&#39;, &#39;sunset&#39;]
cities = {
    &#39;Charlotte&#39; : {key:[] for key in types},
    &#39;Seattle&#39; : {key:[] for key in types}
}

dates = [day[0] for day in arrow.Arrow.span_range(&#39;day&#39;, start, end)]
totals = {city:0 for city in cities}

def floathours(dto):
    return dto.hour + (dto.minute / 60.0) + (dto.second / 3600.0)

for location in cities:
    city = a[location]
    for day in dates:
        sun = city.sun(date=day, local=True)
        sunrise = floathours(arrow.get(sun[&#39;dawn&#39;]))
        sunset = floathours(arrow.get(sun[&#39;sunset&#39;]))
        hours_sunlight = sunset - sunrise

        cities[location][&#39;sunrise&#39;].append(sunrise)
        cities[location][&#39;sunset&#39;].append(sunset)
        cities[location][&#39;sunlight&#39;].append(hours_sunlight)
        totals[location] = totals[location] + hours_sunlight

d = []
for stype in types:
    for city in cities:
        d.append(
            Scatter(
                name=&amp;quot;{city} - {type}&amp;quot;.format(**{
                    &amp;quot;city&amp;quot;:city,
                    &amp;quot;type&amp;quot;:stype
                }),
                x=dates,
                y=cities[city][stype]
            )
        )

data = Data(d)

layout = Layout(
    title=&#39;Charlotte vs. Seattle Sunlight&#39;,
    yaxis=YAxis(
        title=&#39;Hours (24)&#39;,
        domain = [0,24]
    )
)

plot_url = py.plot(data, layout=layout, filename=&#39;Charlotte vs. Seattle Sunlight&#39;)
print(plot_url)

print(&#39;Charlotte: &#39;, totals[&#39;Charlotte&#39;])
print(&#39;Seattle: &#39;, totals[&#39;Seattle&#39;])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Which created this plot:&lt;/p&gt;

&lt;iframe width=&#34;640&#34; height=&#34;480&#34; frameborder=&#34;0&#34; seamless=&#34;seamless&#34; scrolling=&#34;no&#34; src=&#34;https://plot.ly/~serdmanczyk/224/charlotte-vs-seattle-sunlight/?width=640&amp;height=480&#34; &gt;&lt;/iframe&gt;

&lt;p&gt;The orange lines represent Seattle, and the blue lines represent Charlotte.  The lines on top represent sunset times, bottom the sunrise times, and in the middle the total hours of sunlight across the whole year.  So it can be seen that daylight differences in Seattle are slightly more drastic, but with a result of more total sunlight hours throughout the year.&lt;/p&gt;

&lt;p&gt;Besides the sunlight analysis, all of this is just superficial comparisons.  This was just for kicks and gave me an excuse to mess with weather data.  I&amp;rsquo;ve heard in a few conversations with locals that this winter in Seattle has been substantially sunnier than past years.  &lt;a href=&#34;http://cliffmass.blogspot.com/2015/02/the-origin-of-this-winters-weather.html?m=1&#34;&gt;Professor of Atmospheric Sciences Cliff Mass&amp;rsquo; blog&lt;/a&gt; actually explains the odd weather affecting the US Pacific Northwest and Northeast really well from the perspective of someone who is actually a professional on the subject.  He makes a strong case the weather patterns are due to natural variation and not global warming (while still acknowledging global warming as a pressing issue).&lt;/p&gt;

&lt;p&gt;One thing is for sure, I can&amp;rsquo;t wait for summer here where the days will be long, the air will be dry, and the heat won&amp;rsquo;t commonly go over 70 degrees.  I will not miss the humid heat of the Southeast.  Also, you can&amp;rsquo;t beat the view here:&lt;/p&gt;

&lt;p&gt;&lt;blockquote class=&#34;instagram-media&#34; data-instgrm-captioned data-instgrm-version=&#34;4&#34; style=&#34; background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);&#34;&gt;&lt;div style=&#34;padding:8px;&#34;&gt; &lt;div style=&#34; background:#F8F8F8; line-height:0; margin-top:40px; padding:50% 0; text-align:center; width:100%;&#34;&gt; &lt;div style=&#34; background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;&#34;&gt;&lt;/div&gt;&lt;/div&gt; &lt;p style=&#34; margin:8px 0 0 0; padding:0 4px;&#34;&gt; &lt;a href=&#34;https://instagram.com/p/x2wF7glzkI/&#34; style=&#34; color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;&#34; target=&#34;_top&#34;&gt;Rainier is glowing.&lt;/a&gt;&lt;/p&gt; &lt;p style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;&#34;&gt;A photo posted by Steven Erdmanczyk (@serdmanczyk) on &lt;time style=&#34; font-family:Arial,sans-serif; font-size:14px; line-height:17px;&#34; datetime=&#34;2015-01-15T01:04:34+00:00&#34;&gt;Jan 14, 2015 at 5:04pm PST&lt;/time&gt;&lt;/p&gt;&lt;/div&gt;&lt;/blockquote&gt;
&lt;script async defer src=&#34;//platform.instagram.com/en_US/embeds.js&#34;&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;Well, hope you enjoyed my shitty weather blog.  If you&amp;rsquo;re local to Seattle and happened here, hit me up!  I&amp;rsquo;m interested in meeting up with more developers/makers/engineers in the area (or y&amp;rsquo;know, other cool people too).&lt;/p&gt;

&lt;p&gt;With the post I hope to get back in the swing of blogging.  I plan to pick up again on the GardenSpark project soon.  I also have plans for an automated pet feeder projects in the works!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>GardenSpark: Part Two - Putting It in the Cloud</title>
      <link>http://serdmanczyk.github.io/gardenspark/gardenspark-part-two-putting-it-in-the-cloud/</link>
      <pubDate>Thu, 11 Sep 2014 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/gardenspark/gardenspark-part-two-putting-it-in-the-cloud/</guid>
      <description>

&lt;pre&gt;
This project is undergoing a revamp.  Stay tuned for updates!
&lt;/pre&gt;

&lt;h2 id=&#34;intro:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Intro&lt;/h2&gt;

&lt;p&gt;This is the second part of my project hacking together a home plant/garden monitoring system using the &lt;a href=&#34;https://www.spark.io/&#34;&gt;Spark Core&lt;/a&gt;, sensors, web technologies, and wizardry.  The first part involved making a prototype of Spark attached to a few sensors, then using the Spark itself to stream the sensor data to &lt;a href=&#34;https://plot.ly/&#34;&gt;plotly&lt;/a&gt;.  For my next step I wanted to put an entity in the cloud to consume the data from the Spark, store it away in a database, offer a web interface to access that stored data, as well as handle streaming that data to plotly.&lt;/p&gt;

&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;iframe src=&#34;http://ghbtns.com/github-btn.html?user=serdmanczyk&amp;repo=gardenspark&amp;type=fork&amp;size=large&#34; height=&#34;30&#34; width=&#34;100&#34; frameborder=&#34;0&#34; scrolling=&#34;0&#34; style=&#34;width:100px; height: 30px;&#34; allowTransparency=&#34;true&#34;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;&lt;iframe src=&#34;http://ghbtns.com/github-btn.html?user=serdmanczyk&amp;type=follow&amp;size=large&#34; height=&#34;30&#34; width=&#34;240&#34; frameborder=&#34;0&#34; scrolling=&#34;0&#34; style=&#34;width:240px; height: 30px;&#34; allowTransparency=&#34;false&#34;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;iframe width=&#34;800&#34; height=&#34;600&#34; frameborder=&#34;0&#34; seamless=&#34;seamless&#34; scrolling=&#34;no&#34; src=&#34;https://plot.ly/~serdmanczyk/19/800/600&#34;&gt;&lt;/iframe&gt;

&lt;h2 id=&#34;sending-the-data:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Sending the Data&lt;/h2&gt;

&lt;p&gt;The first step was to alter the Spark sketch to send the data to an intermediary server rather than just to plotly.  I considered a couple options for delivering data such as through TCP in a proprietary format or packaged in HTTP POST requests as JSON.  I eventually decided to use the Spark firmware&amp;rsquo;s ability to &lt;a href=&#34;http://docs.spark.io/firmware/#spark-publish&#34;&gt;publish events&lt;/a&gt; to Spark&amp;rsquo;s cloud servers which can easily be &lt;a href=&#34;http://docs.spark.io/api/#reading-data-from-a-core-events&#34;&gt;subscribed to&lt;/a&gt; by HTTP via &lt;a href=&#34;http://dev.w3.org/html5/eventsource/&#34;&gt;server sent events&lt;/a&gt;.  Being integrated into the Spark firmware, this was simple to setup, and the connection from the core to the Spark cloud is very reliable.  This also decoupled by server code from being connected to the core, making testing simpler.  My main sketch code is now even simpler:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;quot;math.h&amp;quot;
#include &amp;quot;defines.h&amp;quot;
#include &amp;quot;DHT.h&amp;quot;
#include &amp;quot;Adafruit_TSL2561_U.h&amp;quot;

unsigned long timesync = 0;
unsigned long lastloop = 0;

DHT dht(DHTPIN, DHTTYPE);
Adafruit_TSL2561_Unified tsl = Adafruit_TSL2561_Unified(TSL2561_ADDR_FLOAT, 42);

void setup() {
    tsl.enableAutoRange(true);            /* Auto-gain ... switches automatically between 1x and 16x */
    tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_402MS);  /* 16-bit data but slowest conversions */
    tsl.begin();
    dht.begin();

    pinMode(MOISTPIN, INPUT);
    pinMode(TEMPPIN, INPUT);

    timesync = millis();
}

void loop() {
    unsigned long now = millis();

    if ((now - lastloop) &amp;gt; TEN_SECONDS){
        sensors_event_t event;
        char data[42];
        double AirTemp = 0.0;
        double SoilTemp = 0.0;
        double Humidity = 0.0;
        double Light = 0.0;
        double Moisture = 0;

        tsl.getEvent(&amp;amp;event);
        Light = (double)event.light;
        AirTemp = (double)dht.readTemperature();
        Humidity = (double)dht.readHumidity();
        Moisture = ((double)map(analogRead(MOISTPIN), 0, 4096, 0, 330) / 100);  // convert to voltage
        SoilTemp = ((double)analogRead(TEMPPIN) * ANALOGKELVINCONVERSION) + KELVINCELSIUSCONVERSION;

        sprintf(data, &amp;quot;[%03.03f,%03.03f,%03.03f,%03.03f,%03.03f]&amp;quot;, AirTemp, SoilTemp, Humidity, Moisture, Light);
        Spark.publish(&amp;quot;Readings&amp;quot;, data, 300, PRIVATE);

        lastloop = now;
    }else if ((now - timesync) &amp;gt; HALF_A_DAY){
        Spark.syncTime();
        timesync = now;
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;setting-up-the-server-using-nodejs:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Setting Up the Server Using Nodejs&lt;/h2&gt;

&lt;p&gt;As an impetus to learn, and to see what all the hype was about, I decided to use Nodejs to power the server side for this project, for it&amp;rsquo;s ease in getting up and running and for its appeal to IoT (internet of things) applications&lt;/p&gt;

&lt;p&gt;I found it very helpful to take an aside and read some material on the basic workings of Javascript before trying to do too much with Nodejs.  I found this book: &lt;a href=&#34;http://eloquentjavascript.net/&#34;&gt;Eloquent Javascript&lt;/a&gt; a great primer that helped integrate my knowledge based on programming in C to how programming works in Javascript-land.&lt;/p&gt;

&lt;p&gt;For hosting, my &lt;a href=&#34;https://www.openshift.com/&#34;&gt;OpenShift&lt;/a&gt; account had one more free gear available.  Creating a server with a MongoDB database was as simple as running a few commands from the command line using &lt;a href=&#34;https://www.openshift.com/blogs/using-rhc-to-manage-paas-apps&#34;&gt;rhc&lt;/a&gt;, updates are managed automatically using git, and all imported node modules are managed by OpenShift using the same &lt;a href=&#34;https://www.npmjs.org/doc/files/package.json.html&#34;&gt;package.json file&lt;/a&gt; npm uses.  Pretty forking easy.&lt;/p&gt;

&lt;h2 id=&#34;consuming-server-sent-events:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Consuming Server Sent Events&lt;/h2&gt;

&lt;p&gt;The first order of business in my server application was get it connected to the data from the Spark.  Subscribing to the events is as simple as &lt;a href=&#34;http://techblog.hybris.com/2014/05/02/consuming-spark-core-sse-events-via-node-js/&#34;&gt;sending an HTTP request and leaving the connection open&lt;/a&gt;.  However, with my application running for days at a time, I was running into trouble with the connection closing every twelve hours or so (not surpisingly).  Instead of taking a lot of time to homebake a solution, I searched through the &lt;a href=&#34;https://www.npmjs.org/&#34;&gt;npm repository&lt;/a&gt; to find an implementation of html5&amp;rsquo;s &lt;a href=&#34;https://www.npmjs.org/package/eventsource&#34;&gt;EventSource&lt;/a&gt; that&amp;rsquo;s been working very well at reconnecting in the event of errors.  Here&amp;rsquo;s a snipper of my implementation:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;SparkCloud.prototype.init = function init(done){
    var self = this,
        url = &amp;quot;https://api.spark.io/v1/devices/&amp;quot; + self.config.DeviceId + &amp;quot;/events&amp;quot;,
        evsSettings = {
           rejectUnauthorized: false,
           headers:{
              &amp;quot;Transfer-Encoding&amp;quot;:&amp;quot;Chunked&amp;quot;,
              Authorization: &amp;quot;Bearer &amp;quot;+ self.config.AccessToken
           }
        };

    var es = new EventSource(url,evsSettings);
    es.addEventListener(&#39;Readings&#39;, function ParseEvent(event) {
        var sparkObj = JSON.parse(event.data),
            Readings = JSON.parse(sparkObj.data),
            SparkData = {
                &amp;quot;TimeStamp&amp;quot;: sparkObj.published_at,
                &amp;quot;Air Temperature&amp;quot;: Readings[0],
                &amp;quot;Soil Temperature&amp;quot;: Readings[1],
                &amp;quot;Humidity&amp;quot;: Readings[2],
                &amp;quot;Soil Moisture&amp;quot;: Readings[3],
                &amp;quot;Light&amp;quot;: Readings[4]
            };

        self.emit(&#39;data&#39;, SparkData)
    }, false);

    es.onerror = function(){
        console.log(&amp;quot;Error with EventSource connection with SparkCloud&amp;quot;);
    };

    self.es = es;
    done();
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&amp;lsquo;SparkCloud,&amp;rsquo; in the context of the code above, is my own object that inherits from &lt;a href=&#34;http://www.sitepoint.com/nodejs-events-and-eventemitter/&#34;&gt;EventEmitter&lt;/a&gt;.  It gathers data from Spark&amp;rsquo;s stream in the background and emits an object to the rest of my application when data from my core becomes available.&lt;/p&gt;

&lt;p&gt;In the future, Spark intends to add the to feature register an address for their servers to POST the data to via HTTP when events are published.  When this comes available I may implement it at it makes for a better model, but SSE is working in the mean time.&lt;/p&gt;

&lt;h2 id=&#34;saving-to-a-database:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Saving to a database&lt;/h2&gt;

&lt;p&gt;Now that I had my server sending the data, I wanted to save it.  Streaming to plotly is pretty cool, but after you&amp;rsquo;ve expanded beyond your maximum points on your plot you start losing data.  When it comes to plant data, only the past few hours of data is pretty boring, my goal is to see days/weeks/months of data with summaries, bells, and whistles.&lt;/p&gt;

&lt;p&gt;The node-mongodb-native module is recommended but I decided to use the mongojs module because it makes the code easier to read and implement.  A brief overview of the two is given on the &lt;a href=&#34;https://www.openshift.com/blogs/getting-started-with-mongodb-on-nodejs-on-openshift&#34;&gt;OpenShift blog&lt;/a&gt;.  To start I only needed three methods.  One to add new data, to get the most recent entry, and to get entries from a start date to an end date.  Not too complicated, here&amp;rsquo;s the entire module:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;quot;use strict&amp;quot;
var mongojs = require(&#39;mongojs&#39;),
    connection_string = &#39;127.0.0.1:27017/gardenspark&#39;;

// if OPENSHIFT env variables are present, use the available connection info:
if(process.env.OPENSHIFT_MONGODB_DB_PASSWORD){
    connection_string = process.env.OPENSHIFT_MONGODB_DB_USERNAME + &amp;quot;:&amp;quot; +
      process.env.OPENSHIFT_MONGODB_DB_PASSWORD + &amp;quot;@&amp;quot; +
      process.env.OPENSHIFT_MONGODB_DB_HOST + &#39;:&#39; +
      process.env.OPENSHIFT_MONGODB_DB_PORT + &#39;/&#39; +
      process.env.OPENSHIFT_APP_NAME;
};

var db = mongojs(connection_string, [&#39;readings&#39;]),
    readings = db.readings;

readings.ensureIndex({TimeStamp:1});

exports.insert = function insert(Data){
    console.log(&amp;quot;saved data: &amp;quot; + Data.TimeStamp);
    readings.insert(Data, {safe:true}, function(err, objects){
        if (err) {console.warn(err.message);}
    });

    delete Data._id;
};

exports.getReadings = function getReadings(start, end, callback){
    function validDate(dateStr, def){
        return (Date(dateStr) !== &amp;quot;Invalid Date&amp;quot;) ? new Date(dateStr) : new Date(def);
    };

    var query = {
            TimeStamp:{
                $gt:(validDate(start, 0).toISOString()),
                $lt:(validDate(end, Date.now()).toISOString())
            }
        },
        results = [];

    readings.find(query,{_id:false})
        .forEach(function(err,doc){
            if (!doc) {
                return callback(results);
            };
            results.push(doc);
        });
};

exports.getLatest = function getLatest(callback){
    var latest = {};

    readings.find({},{_id:false})
        .sort({TimeStamp:-1})
        .limit(1)
        .forEach(function(err,doc){
            if (!doc) {
                callback(latest);
            };

            latest = doc;
        });
};
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sending-to-plotly:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Sending to plotly&lt;/h2&gt;

&lt;p&gt;For streaming to plotly, I simply adapted code from their &lt;a href=&#34;https://github.com/plotly/plotly-nodejs/tree/master/examples&#34;&gt;streaming example&lt;/a&gt;, to my application, with some modifications for specifying plot names and tokens in a separate file, and adding a heartbeast function and pass a plotting function to a callback from my initialization.  It&amp;rsquo;s noticeably more amicable streaming the data from nodejs to plotly rather than from the Spark.  Hopefully this pieces of the server code will be short lived as my planned next step is to switch from using plotly to drawing the plots myself with my own code.&lt;/p&gt;

&lt;h2 id=&#34;caching-readings-for-plotly:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Caching readings for plotly&lt;/h2&gt;

&lt;p&gt;As another feature I wanted to have the ability to modify the interval at which the application will send data to plotly.  With data being sent from the Spark every 10 seconds the plot will fill rather quickly, and rather than needing to do a git add/commit/push/etc. to update the OpenShift app every time I want to update the interval, using a REST call seemed a lot more convenient.&lt;/p&gt;

&lt;p&gt;With the interval to plot possibly longer or shorter than the interval data is being received, just plotting the most recent value received wouldn&amp;rsquo;t accurately represent the data over that time period.  Instead, I made a module that would cache the average of the readings received over the plotting period.  After the interval from the last plot had elapsed, it would send the average to plotly instead.  Here&amp;rsquo;s a snippet of the moving average piece:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;DataCache.prototype.append = function append(data){
    var self = this,
        c = this.data.count;

    for (var key in data){
        if (key === &amp;quot;TimeStamp&amp;quot;){
            continue;
        };
        if (key in self.data){
            var o = self.data[key],
                n = data[key];

            self.data[key] = o + ((n-o)/(c+1));
        }else{
            self.data[key] = data[key];
        }
    };
    self.data.count++;
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This obviously doesn&amp;rsquo;t handle all error conditions, so isn&amp;rsquo;t a fully robust, but handles well in my app where I have full control.  Then for modifying the interval I simply made another method for the DataCache object.  The interval is stored as a member.  When the interval length is modified, the interval variable is cleared and modified.  Every time the interval is triggered, the object will emit the averaged data (if any) to any listeners.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;DataCache.prototype.setEmitInterval = function setEmitInterval(ms){
    var self = this;

    self.timeout = ms;
    if (self.interval !== undefined){
        clearInterval(self.interval);
    };

    self.interval = setInterval(function(){
        if (self.data.count &amp;gt; 0){
            self.emit(&#39;interval&#39;, self.get());
        };
    }, self.timeout);
};
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;hosting-an-interface:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Hosting an interface&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/web_interface_preview.png&#34; alt=&#34;web interface&#34; /&gt;&lt;/p&gt;

&lt;p&gt;It seems there&amp;rsquo;s quite the variety of frameworks for rendering web interfaces for Nodejs.  I stuck with the what seemed the most basic: &lt;a href=&#34;http://expressjs.com/&#34;&gt;express&lt;/a&gt;.  All I wanted was a simple home page that displays the latest reading alongside the current interval time.  Besides that, I wanted to be able to request data between specified time intervals in either a web page or, if the content type header is specified, as JSON for the use in APIs (such as a plotting utility).  I made sure to default the page for displaying readings to the 50 most recent readings, and not to return all data unless explicitly requested.  Using jade templates made rendering the pages from simple javascript objects a breeze.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;app.get(&#39;/&#39;, function(req,res){
    db.getLatest(function(data){
        if (req.headers[&#39;content-type&#39;] === &#39;application/json&#39;){
            res.send(JSON.stringify(data));
        }else{
            data.TimeStamp = (new Date(data.TimeStamp));
            var rs = \_.map(data, function(v,k,l){
                    return {name:k,value:v};
                });
            res.render(&#39;index&#39;,{
                title:name,
                readings:rs,
                interval:cache.timeout.toString()
            });
        };

    });
});

app.get(&#39;/readings&#39;, function(req, res){
        var n = Date.now(),
            all = (req.query.all ? true : false),
            startDate = (req.query.start || 0),
            endDate = (req.query.end || n);

    if (startDate === 0 &amp;amp;&amp;amp; endDate === n &amp;amp;&amp;amp; !all){
        endDate = Date.now();
        startDate = endDate - 300000; // Five minutes ago
    }else if (all){
        startDate = 0;
        endDate = Date.now();
    };

    db.getReadings(startDate, endDate, function(results) {
        if (req.headers[&#39;content-type&#39;] === &#39;application/json&#39;) {
            res.send(JSON.stringify(results));
        }else{
            var ret = {
                title:name,
                readings:results || []
            };
            res.render(&#39;readings&#39;, ret);
        };
    });
});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here&amp;rsquo;s a preview of the readings interface:
&lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/readings_preview.png&#34; alt=&#34;readings interface&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Check it out!  The server is live, so head on over: &lt;a href=&#34;http://gardenspark-evargreen.rhcloud.com/&#34;&gt;gardenspark-evargreen.rhcloud.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Check out the &lt;a href=&#34;http://gardenspark-evargreen.rhcloud.com/readings&#34;&gt;readings page&lt;/a&gt;, and an example of getting readings over &lt;a href=&#34;http://gardenspark-evargreen.rhcloud.com/readings?start=2014-09-11T16:00:00.000Z&amp;amp;end=2014-09-11T17:00:00.000Z&#34;&gt;an interval&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;summary:80bdf840bb03d6cab3ef663bac316d7c&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Here&amp;rsquo;s a basic diagram of the system as it is now: x&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/gardenspark_serverdiagram.png&#34; alt=&#34;System Overview&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Thanks to Nodejs&amp;rsquo; architecture, with callbacks and event emitters, it was particularly efficient to implement this architecture in an easy to read and snappy fashion without an excessive amount of get-up-and-go time.  Nodejs will definitely be a handy tool for other personal projects I take up.  Now, with a web interface, it&amp;rsquo;s been easy to check up on my system and verify readings have been occurring properly.  I can now even use it for the practical purpose of seeing if I need to water my plant, if it gets too much sunlight during a particular part of the day, if an A/C vent is hitting it the plant too hard, etc.  Exciting stuff!&lt;/p&gt;

&lt;p&gt;For the next part of this project I&amp;rsquo;m going to deviate into the less familiar realm (for myself at least) of graphics and interface design and attempt to implement the &lt;a href=&#34;http://d3js.org/&#34;&gt;D3&lt;/a&gt; library to host the plots themselves via my web interface.  Hopefully this will enable more responsive charts as well as the ability to visualize the data more intuitively.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Steven J. Erdmanczyk Jr: Software/Electrical Engineer</title>
      <link>http://serdmanczyk.github.io/about/</link>
      <pubDate>Fri, 08 Aug 2014 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/about/</guid>
      <description>&lt;p&gt;I&amp;rsquo;m a software developer currently working in Go and Python with a history in C, C++, and asm.  By day I work at Disney in Seatte, WA and by nights I try to tinker with embedded electronics when I can squeeze it in.  I have a Master&amp;rsquo;s of Science in Electrical Engineering from the University of North Carolina at Charlotte.  Professionally I enjoy backend system design and programming focused on highly available, distributed systems.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/other/iceland_selfpic.jpg&#34; alt=&#34;Selfie in Iceland&#34; /&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>GardenSpark: Part One - Prototype / stream to plotly</title>
      <link>http://serdmanczyk.github.io/gardenspark/GardenSpark-Prototyping/</link>
      <pubDate>Tue, 22 Jul 2014 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/gardenspark/GardenSpark-Prototyping/</guid>
      <description>

&lt;pre&gt;
This project is undergoing a revamp.  Stay tuned for updates!
&lt;/pre&gt;

&lt;h2 id=&#34;intro:2753be554e797cd6a2ab8852ac642412&#34;&gt;Intro&lt;/h2&gt;

&lt;p&gt;My specialty is working with software and electronics, but also being a fan of nature and reducing our footprint on earth, sometimes I feel my occupation is often contradictory to some of my philosophies.  In the interest of closing this gap and walking down the path of leveraging technology to help us live a lower impact existence, I thought a great personal project would be a system that helps use technology to connect people with growing their our own food.&lt;/p&gt;

&lt;table&gt;&lt;tr&gt;&lt;td&gt;&lt;iframe src=&#34;http://ghbtns.com/github-btn.html?user=serdmanczyk&amp;repo=gardenspark&amp;type=fork&amp;size=large&#34; height=&#34;30&#34; width=&#34;100&#34; frameborder=&#34;0&#34; scrolling=&#34;0&#34; style=&#34;width:100px; height: 30px;&#34; allowTransparency=&#34;true&#34;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;td&gt;&lt;iframe src=&#34;http://ghbtns.com/github-btn.html?user=serdmanczyk&amp;type=follow&amp;size=large&#34; height=&#34;30&#34; width=&#34;240&#34; frameborder=&#34;0&#34; scrolling=&#34;0&#34; style=&#34;width:240px; height: 30px;&#34; allowTransparency=&#34;false&#34;&gt;&lt;/iframe&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

&lt;p&gt;This is definitely a budding application with a few products just recently being funded on Kickstarter.  Just to list a few projects/products:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.edyn.com/&#34;&gt;Edyn&lt;/a&gt;: (my favorite) Garden sensor and smart watering device&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.harvestgeek.com/&#34;&gt;HarvestGeek&lt;/a&gt;: Garden sensing and visualization (unfortunately it seems they are behind on delivering after their kickstarter was funded)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.growerbot.com/&#34;&gt;GrowerBot&lt;/a&gt;: (formerly Garduino) An Arduino based plant monitoring system&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://gardenbot.org/&#34;&gt;GardenBot&lt;/a&gt;: Not a product, but an open source set of plant sensor designs and tutorials&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://bit.ly/1pnlyFF&#34;&gt;Streaming Data to Plotly Using the DHT22&lt;/a&gt; - A simple example of streaming environment data to a live graph online.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This is definitely an area of interest With the growing popularity of the &amp;ldquo;Internet of Things.&amp;rdquo;  This will give me the opportunity to start playing around in that area, renew/refresh my embedded programming skills, and also learn and implement other new frameworks in the process.&lt;/p&gt;

&lt;p&gt;The current scope of this project goes through the following stages, with this post covering the first stage:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Prototype integrating a micro-controller with sensors, and stream the readings to &lt;a href=&#34;https://plot.ly/&#34;&gt;plotly&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Set up a server using &lt;a href=&#34;http://nodejs.org/&#34;&gt;nodejs&lt;/a&gt; to consume sensor data, save data to a database, and offer a simple web interface to preview the data.&lt;/li&gt;
&lt;li&gt;Upgrade web interface to plot eye friendly charts of the data using the &lt;a href=&#34;http://d3js.org/&#34;&gt;D3&lt;/a&gt; library.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Other planned non-step dependent additions&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Connect pump to mcu for automated watering based on sensor readings&lt;/li&gt;
&lt;li&gt;Implement manual trigger for watering via cloud API&lt;/li&gt;
&lt;li&gt;Design pretty enclosure for sensors that&amp;rsquo;s environment proof&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;Add battery/solar power to mcu.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;After some reading through parts used in the other projects I decided on the following hardware to start:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.spark.io/&#34;&gt;Spark Core&lt;/a&gt; for processing and internet connectivity

&lt;ul&gt;
&lt;li&gt;Built-in WiFi and cloud connection libraries&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.adafruit.com/products/385&#34;&gt;DHT22&lt;/a&gt; for Air Temperature / Humidity

&lt;ul&gt;
&lt;li&gt;0 to 100% humidity w/ 2 to 5% accuracy&lt;/li&gt;
&lt;li&gt;-40 to 80 C temperature w/ +-0.5C accuracy&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://amzn.to/1qMxZGs&#34;&gt;LM335&lt;/a&gt; for measuring Soil Temperature

&lt;ul&gt;
&lt;li&gt;-40C to +100C temperature w/ +-1C accuracy&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://amzn.com/B00B886H7S&#34;&gt;DFRobot Soil Moisture Sensor&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;Analog voltage output increases with wetness&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.adafruit.com/products/439&#34;&gt;TSL2561&lt;/a&gt; for measuring Lux (Light)

&lt;ul&gt;
&lt;li&gt;0.1 - 40,000 Lux&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Since apparently all the other projects get their own cool titles I&amp;rsquo;ve dubbed the working title for my project: GardenSpark.  It goes in a garden, it uses the Spark Core, and it intends to &amp;lsquo;spark&amp;rsquo; interest in growing your own plants and food.  Aren&amp;rsquo;t I clever.&lt;/p&gt;

&lt;h2 id=&#34;humidity-air-temperature:2753be554e797cd6a2ab8852ac642412&#34;&gt;Humidity / Air Temperature&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/dht22.jpg&#34; alt=&#34;LM335 Soil Temp Sensor Circuit Schematic&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Connecting to the &lt;a href=&#34;http://www.adafruit.com/products/385&#34;&gt;DHT22&lt;/a&gt; was made super easy by using the Arduino libraries for the sensor provided by &lt;a href=&#34;https://learn.adafruit.com/dht/downloads&#34;&gt;Adafruit&lt;/a&gt;.  It uses a single wire bus, so getting a reading involves setting a pin high for a specified amount of milliseconds, then switching the pin back to an input and counting on your board&amp;rsquo;s timing to process the duration of highs and lows in the returned signal which contains the sensors serialized response values.  Luckily, the adafruit libraries were pretty much plug-and-play on the Spark despite being written for Arduino.  Connecting was simple:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Vin -&amp;gt; Spark 3.3V*&lt;/li&gt;
&lt;li&gt;GND -&amp;gt; Spark GND&lt;/li&gt;
&lt;li&gt;data pin -&amp;gt; Spark Digital pin (your preference)&lt;/li&gt;
&lt;li&gt;data pin -&amp;gt; pull-up resistor -&amp;gt; 3.3V*&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;lux-light:2753be554e797cd6a2ab8852ac642412&#34;&gt;Lux (Light)&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/TLS2561.png&#34; alt=&#34;LM335 Soil Temp Sensor Circuit Schematic&#34; /&gt;&lt;/p&gt;

&lt;p&gt;The &lt;a href=&#34;http://www.adafruit.com/products/439&#34;&gt;TSL2561&lt;/a&gt; communicates via I2C, which the Spark Core conveniently provides on pins D0(Serial Data / SDA) and D1(Serial Clock / SCL) via their &lt;a href=&#34;http://docs.spark.io/firmware/#communication-wire&#34;&gt;Wire&lt;/a&gt; library.  Also, like the DTH22, Adafruit is once again kind enough to provide a &lt;a href=&#34;https://learn.adafruit.com/tsl2561/&#34;&gt;tutorial&lt;/a&gt; and  &lt;a href=&#34;https://learn.adafruit.com/tsl2561/use&#34;&gt;code library&lt;/a&gt; to do the communications and calculations for you.  This library was basically plug-and-play on the Spark as well, save for some modification to match the Arduino application headers and I2C library to the Spark Core.  Wiring the sensor was also easy, as it only required four pins:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Vin -&amp;gt; Spark Core 3.3V*&lt;/li&gt;
&lt;li&gt;GND -&amp;gt; Spark GND&lt;/li&gt;
&lt;li&gt;SDA -&amp;gt; Spark D0(SDA)&lt;/li&gt;
&lt;li&gt;SCL -&amp;gt; Spark D1(SCL)&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;soil-moisture:2753be554e797cd6a2ab8852ac642412&#34;&gt;Soil Moisture&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/SoilMoistureSensor.png&#34; alt=&#34;LM335 Soil Temp Sensor Circuit Schematic&#34; /&gt;&lt;/p&gt;

&lt;p&gt;For sensing soil moisture, instead of going through the trouble of &lt;a href=&#34;http://gardenbot.org/howTo/soilMoisture/&#34;&gt;using nails&lt;/a&gt;, I went with a pre-made sensor from &lt;a href=&#34;http://amzn.com/B00B886H7S&#34;&gt;DFRobot&lt;/a&gt; to save time.  I may make my own sensor to match the final prototype enclosure.  Of course, there are no pre-defined units for how moist soil is, so the sensor only gives an analog output voltage approximately proportional to how wet the soil is.  One pitfall of the sensor documentation is that it is written specifically for Arduino users, giving the output values as:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;0-300: dry soil&lt;/li&gt;
&lt;li&gt;300-700: humid soil&lt;/li&gt;
&lt;li&gt;700-900: in water&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;What do these values mean?  These are actually the output of AnalogRead() on the Arduino, and a look at the Arduino documentation for AnalogRead() says that the output maps values of 0 to 5V to integer values of 0 to 1023, or ~4.9mV per value.  The Spark Core is different, so our values aren&amp;rsquo;t the same.  The Spark analogRead() maps values between 0 to 3.3V(instead of 5V) to integer values from 0 to 4095, or ~0.8mV per unit.  So to figure what the Spark Core reading is for those values we need to:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;convert those AnalogRead() values to the actual voltage output&lt;/li&gt;
&lt;li&gt;convert that voltage output from that of a Vin of 5V down to 3.3V&lt;/li&gt;
&lt;li&gt;convert that to the analogRead() value on the Spark Core for that voltage&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Our actual values come out mapped to be:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;|Arduino (Vin=5V)| AnalogRead() | Vout   |Spark Core (Vin=3.3V)| Vout  |  analogRead() |
||:-----------: | :----: || :---: | :-----------: |
||  0           |  0     || 0     | 0             |
||  300         |  1.465 || 0.967 | 1200          |
||  700         |  3.418 || 2.256 | 2800          |
||  900         |  4.395 || 2.90  | 3600          |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Of course this is all still approximate.  Dry is dry and wet is wet, but it was fun to calculate.&lt;/p&gt;

&lt;h2 id=&#34;soil-temperature:2753be554e797cd6a2ab8852ac642412&#34;&gt;Soil Temperature&lt;/h2&gt;

&lt;p&gt;This one was the most interesting.  I used &lt;a href=&#34;http://gardenbot.org/howTo/soilTemp/&#34;&gt;this tutorial&lt;/a&gt; on GardenBot as a template.  It gives an excellent starting point and base info, but I found their schematics and description a bit disjointed.  Oddly, it starts off telling you to solder adjustment resistors with the sensor to go in the ground, and then proceeds later to explain why this is a bad idea (changes in soil temperature changes resistance, resistance effects calibration).  I did a bit of research to figure better resistance values and get a complete schematic, with a little help from &lt;a href=&#34;http://bit.ly/1nJAbNY&#34;&gt;this post on StackExchange&lt;/a&gt;.  After having refreshed my electronics knowledge a bit, my wiring ended up as the following schematic, which may be simpler and easier to understand than the GardenBot schematics:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/gardenspark/LM335_Temp_Schematic.png&#34; alt=&#34;LM335 Soil Temp Sensor Circuit Schematic&#34; /&gt;&lt;/p&gt;

&lt;p&gt;I chose to use a potentiometer to adjust the LM335 during the prototyping phace, and did some calculations to figure that the resistor between the output node and ground needed to be 270 ohms (not 1K) so that the LM335 would get the proper current for the temperature values I desired to read.  The capacitor is there as a noise filter.  I&amp;rsquo;ll pick two resistors similar to the pot setting for the final prototype.&lt;/p&gt;

&lt;p&gt;Calculating the readings on the Spark was a bit straightforward.  It&amp;rsquo;s a matter of multiplying by a constant to convert the voltage reading to kelvin then adding an offest to convert to celsius.  The sensor&amp;rsquo;s output is approximately +10mv for every Kelvin.  You&amp;rsquo;ll remember from the last section that the Spark readings analog input as integers between 0-4096 to correspond with voltages from 0-3.3V.  The formula for converting the analog input to Kelvin is: Kelvin = input*(3.&lt;sup&gt;3&lt;/sup&gt;&amp;frasl;&lt;sub&gt;4096&lt;/sub&gt;)*100.  To convert to Celsius you simply subtract 273.15.&lt;/p&gt;

&lt;p&gt;Currently I have the LM335 connected on the breadboard and am observing it in relation to the DHT22.  Their appears to be some adjusting to do still to get it accurately calibrated, which I&amp;rsquo;ll have to do when I have access to better equipment (such as at our local &lt;a href=&#34;http://hackerspacecharlotte.org/&#34;&gt;Charlotte Hackerspace&lt;/a&gt;).  Once that&amp;rsquo;s done I plan to do the further physical work to heat-shrink the sensor into a component that can be inserted into the soil.&lt;/p&gt;

&lt;h2 id=&#34;streaming-to-plotly:2753be554e797cd6a2ab8852ac642412&#34;&gt;Streaming to Plotly&lt;/h2&gt;

&lt;p&gt;Connecting to the internet with the Spark is made easy out of the box, you simply set your WiFi credentials with the mobile app or the &lt;a href=&#34;]http://docs.spark.io/cli/&#34;&gt;spark cli&lt;/a&gt; and it will automatically connect every time it runs.  Programming the MCU is made easy by their web IDE, but you can also program via USB by setting up the nodejs based spark cli, which I found very useful.  It still requires the spark cloud to compile code into a firmware binary.  The language is very similar to Arduino (which is based on &lt;a href=&#34;http://wiring.org.co/&#34;&gt;Wiring&lt;/a&gt;, which is base on &lt;a href=&#34;http://processing.org/&#34;&gt;Processing&lt;/a&gt;&amp;hellip;).&lt;/p&gt;

&lt;p&gt;For connecting the core to the plotly API, once again, a library already exists!  Plotly provides an &lt;a href=&#34;https://github.com/plotly/arduino-api&#34;&gt;Arduino library&lt;/a&gt;, which was re-purposed ever so slightly &lt;a href=&#34;https://github.com/krvarma/Plotly_SparkCore&#34;&gt;here&lt;/a&gt; for the Spark Core.  It makes plotting easy by encapsulating the &lt;a href=&#34;https://plot.ly/streaming/&#34;&gt;Plotly REST API&lt;/a&gt; calls to initialize the graph and send data into an easy to use C++ class.  Unfortunately there were some errors in the HTTP POST built on the Spark Core version, but I easily corrected them (and it seems as of the time of this writing, the errors have been fixed in the repository).  Since the update interval I desired was farther apart than the plotly API allows, I also had to add code to send a &lt;a href=&#34;https://github.com/plotly/Streaming-Demos#advanced-streaming-concepts&#34;&gt;heartbeat message&lt;/a&gt; within every minute interval to ensure plotly doesn&amp;rsquo;t disconnect.  After getting the library running, I had data!  You can check out my streaming test graph (live from my house!) below (update, the stream is now coming from my intermediary nodejs server, but it&amp;rsquo;s still the same data source):&lt;/p&gt;

&lt;iframe width=&#34;800&#34; height=&#34;600&#34; frameborder=&#34;0&#34; seamless=&#34;seamless&#34; scrolling=&#34;no&#34; src=&#34;https://plot.ly/~serdmanczyk/19/800/600&#34;&gt;&lt;/iframe&gt;

&lt;h2 id=&#34;putting-it-all-together:2753be554e797cd6a2ab8852ac642412&#34;&gt;Putting it All Together&lt;/h2&gt;

&lt;p&gt;With all the parts assembled, the base sketch was very simple.  To start I chose to plot data every five minutes, which would make a full 24 hours of data on the graph equal a manageable 288 points.  All I needed to do was:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Initialize the requisite classes and variables&lt;/li&gt;
&lt;li&gt;Monitor millis() (milliseconds elapsed in program) value

&lt;ul&gt;
&lt;li&gt;Every 5 minutes, read sensor data and send to plotly&lt;/li&gt;
&lt;li&gt;Every 50 seconds (within a minute): send a heartbeat to plotly so the server doesn&amp;rsquo;t close the connection&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;You&amp;rsquo;ll also notice I used Spark&amp;rsquo;s firmware library to set &amp;lsquo;variables&amp;rsquo; for the sensor readings.  This enabled me to monitor readings from the sensors on the fly through &lt;a href=&#34;http://docs.spark.io/api/#reading-data-from-a-core-variables&#34;&gt;Spark&amp;rsquo;s cloud API&lt;/a&gt; rather than have to wait 5 minutes to check the readings being plotted, which was very handy especially because it was wireless unlike a serial connection. Here&amp;rsquo;s my entire main sketch:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;quot;plotly_spark.h&amp;quot;
#include &amp;quot;plotly_defines.h&amp;quot;
#include &amp;quot;math.h&amp;quot;
#include &amp;quot;DHT.h&amp;quot;
#include &amp;quot;Adafruit_TSL2561_U.h&amp;quot;

#define TEMPPIN A0
#define MOISTPIN A1
#define DHTPIN D4
#define DHTTYPE DHT22

#define FIVE_MINUTES (5*60*1000)
#define FIFTY_SECONDS (50*1000)

// convert input volage reading to kelvin; 10mV = 1 K
#define ANALOGKELVINCONVERSION 0.08056640625 // (3.3/4096)*100

double Temp = 0.0;
double SoilTemp = 0.0;
double Humidity = 0.0;
double Light = 0.0;
int Moisture = 0;

unsigned long lastloop = 0;
unsigned long heartbeat = 0;

char *tokens[TOKENS] = {AIRTEMPTOK, HUMIDTOK, SOILTEMPTOK, MOISTURETOK, LIGHTTOK};
plotly graph = plotly(USERNAME, APITOKEN, tokens, PLOTNAME, TOKENS);
DHT dht(DHTPIN, DHTTYPE);
Adafruit_TSL2561_Unified tsl = Adafruit_TSL2561_Unified(TSL2561_ADDR_FLOAT, 42);

void setup() {
    tsl.enableAutoRange(true);
    tsl.setIntegrationTime(TSL2561_INTEGRATIONTIME_402MS);

    tsl.begin();
    dht.begin();

    pinMode(MOISTPIN, INPUT);
    pinMode(TEMPPIN, INPUT);
    Spark.variable(&amp;quot;Temperature&amp;quot;, &amp;amp;Temp, DOUBLE);
    Spark.variable(&amp;quot;SoilTemperature&amp;quot;, &amp;amp;SoilTemp, DOUBLE);
    Spark.variable(&amp;quot;Humidity&amp;quot;, &amp;amp;Humidity, DOUBLE);
    Spark.variable(&amp;quot;Light&amp;quot;, &amp;amp;Light, DOUBLE);
    Spark.variable(&amp;quot;Moisture&amp;quot;, &amp;amp;Moisture, INT);

    graph.fileopt = &amp;quot;extend&amp;quot;;
    graph.log_level = 4;
    graph.maxpoints = 288;
    graph.init();
    graph.openStream();
    heartbeat = millis();
}

void loop() {
    unsigned long now = millis();

    if ((now - lastloop) &amp;gt; FIVE_MINUTES){
      sensors_event_t event;

      tsl.getEvent(&amp;amp;event);
      Light = (double)event.light;
      Temp = (double)dht.readTemperature();
      Humidity = (double)dht.readHumidity();
      Moisture = map(analogRead(MOISTPIN), 0, 4096, 0, 330);
      SoilTemp = (double)analogRead(TEMPPIN);
      SoilTemp = (SoilTemp * ANALOGKELVINCONVERSION) - 273.15;

      graph.plot(now, (float)Temp, tokens[0]);
      graph.plot(now, (float)Humidity, tokens[1]);
      graph.plot(now, (float)SoilTemp, tokens[2]);
      graph.plot(now, Moisture, tokens[3]);
      graph.plot(now, (float)Light, tokens[4]);

      lastloop = now;
  }else if((now-heartbeat) &amp;gt; FIFTY_SECONDS){
      graph.heartbeat();
      heartbeat = now;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can see the rest of the code in the &lt;a href=&#34;https://github.com/serdmanczyk/gardenspark/tree/sparkonly&#34;&gt;&amp;lsquo;spark only&amp;rsquo; branch of my github repo&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;results:2753be554e797cd6a2ab8852ac642412&#34;&gt;Results&lt;/h2&gt;

&lt;p&gt;Thanks to libraries and resources on the internet getting the basic sensors set up was made super easy.  Setting up the LM335 was a good refresher on basic electronics.  The Spark Core made internet connectivity very easy, and at a super affordable price (especially since mine was a birthday gift from my sister ^_^).  I still need to do some tuning to get the LM335 calibrated, and there are some bugs with the timestamp values drifting using plotly&amp;rsquo;s Arduino API.  After some experimenting with nodejs, it seems much more friendly with plotly&amp;rsquo;s API, so I look forward to getting the server portion going.  I also look forward to getting a database going so I can start observing patterns in the data over time.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Online Class Attendance App using Flask/MongoDB</title>
      <link>http://serdmanczyk.github.io/ClassAtttendanceApp/</link>
      <pubDate>Wed, 18 Jun 2014 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/ClassAtttendanceApp/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/classattendance/Classes.png&#34; alt=&#34;Classes HomePage&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;motivation:06e3b8cf457e2107d1200d1c47e493de&#34;&gt;Motivation&lt;/h1&gt;

&lt;p&gt;My friends and I teach a parkour class at a local gymnastics gym, which we organize ourselves.  We needed a solid method for logging attendance.  There were many free solutions, but they all followed the attendance model similar to school classroom attendance: each class has assigned students and you mark attendance by checking them off as absent, tardy, attended, excused, etc.  This didn&amp;rsquo;t fit our model because we ran our class on a come-as-you-can basis.  For lack of a better solution we used an Excel Google Doc or just left our attendance logs on paper.&lt;/p&gt;

&lt;p&gt;Fast forward: not long ago I decided to take MongoDB&amp;rsquo;s free &lt;a href=&#34;https://university.mongodb.com/&#34;&gt;on-line developer&amp;rsquo;s course&lt;/a&gt;.  Part of the class used a simple blog example using the &lt;a href=&#34;http://bottlepy.org/docs/dev/index.html&#34;&gt;Bottle framework&lt;/a&gt; in Python, which made me think that a Python framework / MongoDB application would suit itself extremely well to what we wanted.  So I set to working using these tools to write my own simple class attendance application in my free time.&lt;/p&gt;

&lt;h1 id=&#34;overview:06e3b8cf457e2107d1200d1c47e493de&#34;&gt;Overview&lt;/h1&gt;

&lt;p&gt;My final application is pieced together using the following components:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The &lt;a href=&#34;http://flask.pocoo.org/&#34;&gt;Flask micro-framework&lt;/a&gt; to host the web interface, with &lt;a href=&#34;http://jinja.pocoo.org/docs/&#34;&gt;Jinja2&lt;/a&gt; to template web pages based on Python objects.&lt;/li&gt;
&lt;li&gt;Flask&amp;rsquo;s &lt;a href=&#34;https://pythonhosted.org/Flask-OAuth/&#34;&gt;Oauth plug-in&lt;/a&gt; to enable using Google OAuth for simple user authentication.&lt;br /&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://api.mongodb.org/python/current/&#34;&gt;PyMongo&lt;/a&gt; to link the web framework to the &lt;a href=&#34;http://www.mongodb.org/&#34;&gt;MongoDB&lt;/a&gt; database.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://purecss.io/&#34;&gt;Pure CSS&lt;/a&gt; to simplify making the pages look &amp;lsquo;pretty.&amp;rsquo;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://jqueryui.com/&#34;&gt;JQuery UI&lt;/a&gt; simplified adding handy interface features such as a javascript calendar to select class dates as well as student name auto-completion during attendance logging.&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.openshift.com/&#34;&gt;OpenShift&lt;/a&gt; by RedHat for a free hosting solution easily managed by git and ssh.&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;schema:06e3b8cf457e2107d1200d1c47e493de&#34;&gt;Schema&lt;/h1&gt;

&lt;p&gt;The MongoDB database schema uses four collections:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;authentication: contains Google Oauth credentials as well as the secret key for the application.&lt;/li&gt;
&lt;li&gt;coaches: contains all coaches as well as their e-mails to validate against Google Oauth login.&lt;/li&gt;
&lt;li&gt;students: holds all details about students such as emergency contacts, e-mail, birthdays, etc.&lt;/li&gt;
&lt;li&gt;classes: Contains all records of classes.  Each record contains a date and associates to the record for its indicated coach.  Within the record is a list of attendances with purchase info if applicable and an association to a student record for the attended student.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The schema for the student and classes collections are shown below.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Students
{
    &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;53a0ee5b798a010258167aa7&amp;quot;),
    &amp;quot;firstname&amp;quot; : &amp;quot;Eunice&amp;quot;,
    &amp;quot;lastname&amp;quot; : &amp;quot;Anderson&amp;quot;,
    &amp;quot;gender&amp;quot; : &amp;quot;female&amp;quot;,
    &amp;quot;email&amp;quot; : &amp;quot;altheabanks@zensor.com&amp;quot;
    &amp;quot;dob&amp;quot; : ISODate(&amp;quot;1997-09-25T00:00:00Z&amp;quot;),
    &amp;quot;emergencyphone&amp;quot; : &amp;quot;+1 (949) 511-3347&amp;quot;,
    &amp;quot;emergencycontact&amp;quot; : &amp;quot;Althea Banks&amp;quot;,
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;# Classes
{
    &amp;quot;_id&amp;quot; : ObjectId(&amp;quot;53a0f734798a0110dc74abc1&amp;quot;),
    &amp;quot;date&amp;quot; : ISODate(&amp;quot;2014-01-01T00:00:00Z&amp;quot;),
    &amp;quot;coach&amp;quot; : ObjectId(&amp;quot;53a0ef10798a010f40e8cabc&amp;quot;),
    &amp;quot;type&amp;quot; : &amp;quot;beginner&amp;quot;
    &amp;quot;attendance&amp;quot; : [
        {
            &amp;quot;student&amp;quot; : ObjectId(&amp;quot;53a0ee5b798a010258167ab6&amp;quot;)
        },
        {
            &amp;quot;payment&amp;quot; : {
                &amp;quot;amount&amp;quot; : 15,
                &amp;quot;method&amp;quot; : &amp;quot;credit&amp;quot;,
                &amp;quot;purchased&amp;quot; : &amp;quot;drop in&amp;quot;
            },
            &amp;quot;student&amp;quot; : ObjectId(&amp;quot;53a0ee5b798a010258167ab5&amp;quot;)
        },
        {
            &amp;quot;payment&amp;quot; : {
                &amp;quot;amount&amp;quot; : 0,
                &amp;quot;method&amp;quot; : &amp;quot;punched&amp;quot;,
                &amp;quot;purchased&amp;quot; : null
            },
            &amp;quot;student&amp;quot; : ObjectId(&amp;quot;53a0ee5b798a010258167aaf&amp;quot;)
        },
        ...
    ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/classattendance/Schema.png&#34; alt=&#34;Schema Diagram&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;screenshots:06e3b8cf457e2107d1200d1c47e493de&#34;&gt;Screenshots&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/classattendance/Class.png&#34; alt=&#34;Class Page&#34; /&gt;
&lt;img src=&#34;http://serdmanczyk.github.io/images/classattendance/Students.png&#34; alt=&#34;Students Page&#34; /&gt;
&lt;img src=&#34;http://serdmanczyk.github.io/images/classattendance/edit_student.png&#34; alt=&#34;Edit Student Page&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;demo-and-source-code:06e3b8cf457e2107d1200d1c47e493de&#34;&gt;Demo and Source Code&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;http://classdemo-evargreen.rhcloud.com/&#34; class=&#34;btn btn-success&#34;&gt;Live Demo&lt;/a&gt;    &lt;a href=&#34;https://github.com/serdmanczyk/parkour_class_attendance_app&#34; class=&#34;btn btn-success&#34;&gt;GitHub Repository&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Editing on the demo is disabled, but forms buttons will still follow through to their final destinations.  Authorization through Google is still used, no user info is maintained, just a session token.  All student and coach data is random sample data generate using &lt;a href=&#34;http://www.json-generator.com/&#34;&gt;json-generator&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;All source code including provisions for OpenShift is available on GitHub.  Fork it and build it into your own class app!&lt;/p&gt;

&lt;h1 id=&#34;summary:06e3b8cf457e2107d1200d1c47e493de&#34;&gt;Summary&lt;/h1&gt;

&lt;p&gt;This is just a quick base application I programmed for fun to get practice using new frameworks and technologies.  Future work includes adding more feedback to users when errors happend server-side.  Currently there&amp;rsquo;s no real error checking and only minor form validation.  If there&amp;rsquo;s an exception flask returns a feedback page, if a submit fails the new data simply fails to show up.  I would also add a page to manage coaches as well as an ability to view charts of attendance and revenue over time.  I may use a future post to demonstrate using MapReduce with MongoDB to retrieve related data from two collections in one call, similar to a SQL Join.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>XBee API Mode Tutorial Using Python and Arduino</title>
      <link>http://serdmanczyk.github.io/XBeeAPI-PythonArduino-Tutorial/</link>
      <pubDate>Sun, 01 Jun 2014 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/XBeeAPI-PythonArduino-Tutorial/</guid>
      <description>

&lt;p&gt;&lt;pre&gt;
Disclaimer:  This is meant to be a tutorial.
Primarily this is intended to educate with basic XBee
API mode setup, and how the XBee frame format works.
If you&amp;rsquo;re looking for a library, I recommend for &lt;a href=&#34;https://pypi.python.org/pypi/XBee&#34;&gt;XBee&lt;/a&gt; for
Python and checkout &lt;a href=&#34;https://github.com/andrewrapp/xbee-arduino&#34;&gt;xbee-arduino&lt;/a&gt; for&amp;hellip; yeah.
&lt;/pre&gt;&lt;/p&gt;

&lt;h2 id=&#34;introduction:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;This post is a tutorial, with example code, covering how to communicate using XBee 802.15.4 (Series 1) radios in API mode using Python and Arduino.  I decided to write these tutorials because I couldn&amp;rsquo;t find a substantial amount of simple examples when I decided to use XBee&amp;rsquo;s in API mode while working on my Masters thesis.  It&amp;rsquo;s my hopes this tutorial can help other people working on applications similar to mine get off the ground and running faster.&lt;/p&gt;

&lt;p&gt;Some knowledge of serial/UART communication mechanics, Python, and Arduino will be helpful for this tutorial but not absolutely required.  It&amp;rsquo;s hopeful that this tutorial can aid in your learning if you&amp;rsquo;re also picking these up as you go.  All example code is available at the &lt;a href=&#34;https://github.com/serdmanczyk/XBee_802.15.4_APIModeTutorial&#34; class=&#34;btn btn-success&#34;&gt;GitHub Repository&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This tutorial does assume you are familiar with Digi X-CTU and Arduino software.  You will be instructed what to do in X-CTU and Arduino (e.g. &amp;ldquo;compile&amp;rdquo;, &amp;ldquo;change these settings&amp;rdquo;), but will not be instructed how to do it (e.g. &amp;ldquo;push the blue button&amp;rdquo;, &amp;ldquo;go to menu File-&amp;gt;&amp;rdquo;)&lt;/p&gt;

&lt;h2 id=&#34;requisite-hardware:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Requisite Hardware&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;2 XBee 802.15.4 Series 1 radios&lt;/li&gt;
&lt;li&gt;1 XBee 3.3v-5v adapter / break-out board&lt;/li&gt;
&lt;li&gt;1 XBee USB adapter&lt;/li&gt;
&lt;li&gt;1 Arduino board (This tutorial was written with an &lt;a href=&#34;https://www.sparkfun.com/products/11021&#34;&gt;Uno&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;1 Breadboard and jumper wires&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I recommend the &lt;a href=&#34;http://amzn.com/B00B6SF2C6&#34;&gt;Parallax XBee Wireless Pack&lt;/a&gt;, but there are also several other options on &lt;a href=&#34;https://www.sparkfun.com&#34;&gt;SparkFun&lt;/a&gt;, &lt;a href=&#34;https://www.adafruit.com&#34;&gt;Adafruit&lt;/a&gt;, &lt;a href=&#34;http://www.makershed.com/SearchResults.asp?Search=xbee&#34;&gt;Maker Shed&lt;/a&gt; and other hobby electronics stores.  Many of them are very similar to the pieces used in this post.&lt;/p&gt;

&lt;h2 id=&#34;requisite-software:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Requisite Software&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.digi.com/products/wireless-wired-embedded-solutions/zigbee-rf-modules/xctu&#34;&gt;Digi X-CTU&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.ftdichip.com/FTDrivers.htm&#34;&gt;FTDI Drivers&lt;/a&gt; (for USB to Serial communications)&lt;/li&gt;
&lt;li&gt;Python &lt;a href=&#34;https://www.python.org/download/releases/2.7.7/&#34;&gt;2.7&lt;/a&gt; or &lt;a href=&#34;https://www.python.org/download/releases/3.3.5&#34;&gt;3.3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://pyserial.sourceforge.net/&#34;&gt;PySerial library&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://arduino.cc/en/main/software&#34;&gt;Arduino Software&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;why-xbee-802-15-4:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Why XBee 802.15.4?&lt;/h2&gt;

&lt;p&gt;XBee radios are handy in embedded applications because they enable wireless communications with relatively low power compared to Wi-Fi, bluetooth, or cellular technologies at the cost of slower speed.  XBee 802.15.4 (Series 1) provides simple OSI layer one and two functionality on the module.  Zigbee radios (XBee Series 2) provide an additional networking layer that can handle cool things like automatic mesh networking, however, Zigbee mesh networks are limited to a maximum of 10 nodes.  Zigbee radios can also operate in API mode, frame packaging is the same, and the frames used for Zigbee are very similar.  This tutorial covers XBee 80.15.4 because their frames are simpler for beginners and are all we need to cover the basics.&lt;/p&gt;

&lt;h2 id=&#34;why-xbee-api-mode-a-brief-review:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Why XBee API mode? A Brief Review&lt;/h2&gt;

&lt;p&gt;Using API mode to communicate has a few advantages compared to other XBee configuration options:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;No need for timely switching in/out of command mode to change configuration options&lt;/li&gt;
&lt;li&gt;Message destination addresses can be specified on the fly&lt;/li&gt;
&lt;li&gt;Received message frames come packaged with an RSSI (Received Signal Strength Indicator) byte&lt;/li&gt;
&lt;li&gt;Feedback is provided on message transmission success when enabled&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;In API mode, all incoming and outgoing messages are required to be packaged in frames.  The picture below summarizes a few of the basic frame types based on descriptions in the &lt;a href=&#34;http://ftp1.digi.com/support/documentation/90000982_N.pdf&#34;&gt;XBee 802.15.4 product manual&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/xbeetut/XBeeFramesOverview.png&#34; alt=&#34;API Frames Summary&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Each frame has a minimum of the the following:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Start delimiter byte &lt;code&gt;0x7E&lt;/code&gt; &lt;em&gt;&amp;ldquo;there is a frame here&amp;rdquo;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Most Significant Byte (MSB) &lt;em&gt;&amp;ldquo;the start byte is at: &amp;ldquo;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Least Significant Byte (LSB) &lt;em&gt;&amp;ldquo;the end byte is at: &amp;ldquo;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;API identifier (cmdID) &lt;em&gt;&amp;ldquo;the content looks like: &amp;ldquo;&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;Frame data (including additional bytes specific to API message type)&lt;/li&gt;
&lt;li&gt;Checksum byte &lt;em&gt;&amp;ldquo;all contents compress to: &amp;ldquo;&lt;/em&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The start delimiter simply denotes the beginning of a frame.  The MSB and LSB are used to indicate the length of the data in the frame.  The length of the frame is the number of bytes after the LSB, not including the checksum byte.  The MSB is always 0x00, so the LSB will be equivalent to the length.  Every frame will have an API identifier specifying what type of frame is being sent (this tutorial will cover the 16-bit address transmit and receive message types).  After the API identifier comes any additional bytes required by the specified frame type. After that is the actual frame data (in the case of a transmit and receive frame, the data to transmit/received).  The checksum byte is used to verify the integrity of the contents.  The checksum is calculate using the following process:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Sum value of each byte after LSB&lt;/li&gt;
&lt;li&gt;Preserve only the lower 8 bits (AND with &lt;code&gt;0xFF&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Subtract the value from 255&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This enables simple verification of received frames because the lower 8 bits of the sum of all bytes after the LSB (including the checksum) will be equal to 255 or &lt;code&gt;0xFF&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;After formatting the previous parts, a final step is necessary if you&amp;rsquo;re using API mode with escaped characters.  When escaping is enabled, any bytes (excluding the start delimiter) that contain reserved characters (&lt;code&gt;0x7E&lt;/code&gt;, &lt;code&gt;0x7D&lt;/code&gt;, &lt;code&gt;0x11&lt;/code&gt;, and &lt;code&gt;0x13&lt;/code&gt;) must be escaped so that the XBee will not interpret them as control characters.  This may seem like extra overhead, but escaped mode simplifies message reception so that you can count on any &lt;code&gt;0x7E&lt;/code&gt; byte to only indicate a start delimiter (or an ignorable error).  This removes the need to program for more edge cases and simplifies code.&lt;/p&gt;

&lt;p&gt;To escape a message, anywhere in the message (including the MSB, LSB, and checksum bytes) a reserved character appears, it should be replaced with an &lt;code&gt;0x7D&lt;/code&gt; escape character followed by the original character XOR&amp;rsquo;ed with &lt;code&gt;0x20&lt;/code&gt;.  For example the bytes &lt;code&gt;00 11 23&lt;/code&gt; after escaping would become &lt;code&gt;00 7D 31 23&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;So, in a nutshell, the process for formatting an API frame is:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Calculate the full length of the message (minus start delimiter and checksum) and insert it as the LSB&lt;/li&gt;
&lt;li&gt;Calculate and insert any bytes necessary for the API frame type&lt;/li&gt;
&lt;li&gt;Calculate the checksum and place it at the end of the frame&lt;/li&gt;
&lt;li&gt;Escape any reserved characters (including MSB, LSB, and checksum)&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;That covers the basics of API frames / the boring part.  Now let&amp;rsquo;s actually have some fun.&lt;/p&gt;

&lt;h2 id=&#34;part-one-initial-setup-and-communication-in-transparent-mode:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Part One: Initial Setup and communication in Transparent Mode&lt;/h2&gt;

&lt;p&gt;For all parts of this tutorial we&amp;rsquo;ll have two XBee radios with different settings.  To make things easier we&amp;rsquo;ll give them names.  For the rest of this tutorial &amp;ldquo;Atreyu&amp;rdquo; will refer to the XBee we&amp;rsquo;re connecting to our computer and &amp;ldquo;Falcor&amp;rdquo; will refer to the XBee we&amp;rsquo;re connecting to our Arduino.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/xbeetut/Setup_Diagram.png&#34; alt=&#34;Setup Diagram&#34; /&gt;&lt;/p&gt;

&lt;p&gt;We will start with both XBee&amp;rsquo;s in transparent mode.  Atreyu will connect to the X-CTU console on our computer, and Falcor will be wired in passthrough mode so that it will reflect any messages sent to it directly back to Atreyu.&lt;/p&gt;

&lt;p&gt;First we need to configure the proper parameters on the radios so they will talk to each other.  For both radios, use X-CTU to load the default parameters, and then configure/write the following settings:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;|                   Settings for Atreyu                |
| Name                            | Value              |
|:-----------------------------   | -----------------: |
| `MY` (16-bit source address)    | `0`                |
| `DH` (Destination Address High) | `0`                |
| `DL` (Destination Address Low)  | `1`                |
| `AP` (API Enable)               | `API Disabled [0]` |
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;|                   Settings for Falcor                  |
| Name                            | Value                |
|:-----------------------------   | -------------------: |
| `MY`                            | `1`                  |
| `DH`                            | `0`                  |
| `DL`                            | `0`                  |
| `AP`                            | `API Disabled [0]`   |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Leave Atreyu connected to the computer with the X-CTU software.  Insert Falcor into your 3.3v-5v adapter/break-out board and connect the following pins from the break-out board:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Connect the DIN pin to DOUT (passthrough)&lt;/li&gt;
&lt;li&gt;Connect 5v and GND to a 5v power source&lt;/li&gt;
&lt;li&gt;That&amp;rsquo;s it!&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you like, you can use the Arduino as an overly fanciful power supply.  We will be using it in Part Three, so this way we&amp;rsquo;ll only need to modify one wire when we start communicating with the Arduino.  Connect the Arduino to power (computer USB, or DC-in from wall or a battery) and it will provide enough current through the 5v pin to power the XBee.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/xbeetut/XBeePassThroughGraphic.png&#34; alt=&#34;XBee Pass-Through Mode Connection&#34; /&gt;&lt;/p&gt;

&lt;p&gt;The illustration shows a SparkFun XBee explorer module because it is what is available in &lt;a href=&#34;http://fritzing.org/home/&#34;&gt;fritzing&lt;/a&gt;.  The pin layout is identical to the module in the Parallax kit.
{: .notice}&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;ve set this up correctly, you should now be able to connect to Atreyu with the X-CTU console and start typing text and see it returned like below (Blue text is sent, Red is received).&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/xbeetut/HelloWorld_Passive.png&#34; alt=&#34;Passive Hello World&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Congratulations!  You&amp;rsquo;ve successfully setup and communicated with the XBee&amp;rsquo;s in transparent mode.  Now we&amp;rsquo;re ready to switch Atreyu into API mode and start communicating using Python in part two.&lt;/p&gt;

&lt;h2 id=&#34;part-two-communicating-from-a-pc-w-api-mode-using-python:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Part Two: Communicating from a PC w/API mode using Python&lt;/h2&gt;

&lt;p&gt;Now that we have things setup and we&amp;rsquo;ve verified they can communicate, we can switch our first XBee into API mode and begin sending messages with it via Python. Re-configure the following parameter on Atreyu to enable API mode.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;|        Settings for Atreyu        |
| Name    | Value                   |
| :-----  | -------------------:    |
| `AP`    | `API enabled w/PPP [2]` |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To test in X-CTU, you can create a packet with following Hex contents: &lt;code&gt;7E 00 10 01 00 FF FF 01 48 65 6C 6C 6F 20 57 6F 72 6C 64 E3&lt;/code&gt; (You can copy and paste).  You should be able to send the example packet in the X-CTU console and get a response (still being reflected from Falcor) identical to the second image.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/xbeetut/APIHelloWorldPacket.png&#34; alt=&#34;API Hello World Packet&#34; /&gt;
&lt;img src=&#34;http://serdmanczyk.github.io/images/xbeetut/APIHelloWorldResponse.png&#34; alt=&#34;API Hello World Response&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Congratulations!  You&amp;rsquo;ve sent your first message with XBee API mode.  Now let&amp;rsquo;s send a package using Python.&lt;/p&gt;

&lt;p&gt;Go ahead and clone the GitHub repository for this tutorial if you haven&amp;rsquo;t already.  Also, make sure you have installed PySerial as well.  Now navigate to the Python folder.  You will need to modify line 5 in main.py to match the port your XBee resides on.  Now if you navigate with a command prompt to this folder and run main.py your command prompt output should look like:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ C:/.../main.py
Tx: 7e 00 10 01 00 ff ff 01 48 65 6c 6c 6f 20 57 6f 72 6c 64 e3
Rx: 7e 00 10 81 00 01 24 00 48 65 6c 6c 6f 20 57 6f 72 6c 64 3d
Msg: Hello World
Tx: 7e 00 7d 31 01 00 ff ff 01 7d 5e 7d 5d 7d 31 7d 33 5b 01 01 01 01 01 01 01 7d 5e
Rx: 7e 00 7d 31 81 00 01 24 00 7d 5e 7d 5d 7d 31 7d 33 5b 01 01 01 01 01 01 01 d8
Msg: 7e 7d 11 13 5b 01 01 01 01 01 01 01
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You did it!  What exactly did we do?  Let&amp;rsquo;s start examining the code by looking at the body of main.py.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    xbee = XBee.XBee(&amp;quot;COM3&amp;quot;)  # Your serial port name here

    # A simple string message
    sent = xbee.SendStr(&amp;quot;Hello World&amp;quot;)
    sleep(0.25)
    Msg = xbee.Receive()
    if Msg:
        content = Msg[7:-1].decode(&#39;ascii&#39;)
        print(&amp;quot;Msg: &amp;quot; + content)

    # A message that requires escaping
    xbee.Send(bytearray.fromhex(&amp;quot;7e 7d 11 13 5b 01 01 01 01 01 01 01&amp;quot;))
    sleep(0.25)
    Msg = xbee.Receive()
    if Msg:
        content = Msg[7:-1]
        print(&amp;quot;Msg: &amp;quot; + xbee.format(content))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As can be seen, we sent and received two messages.  The first messages contents were simply &amp;ldquo;Hello World&amp;rdquo; in ascii encoding.  The second message is a bit more obscure, it is formatted to demonstrate API mode character escaping which we&amp;rsquo;ll get more into soon.  Now, let&amp;rsquo;s get into the pieces that are the heart of this tutorial.  Lets start with the XBee &lt;code&gt;__init__()&lt;/code&gt; method.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;class XBee():
    ...
    def __init__(self, serialport, baudrate=9600):
        self.serial = serial.Serial(port=serialport, baudrate=baudrate)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All the class constructor does is initialize the serial port.  You can read more on PySerial options in the &lt;a href=&#34;http://pyserial.sourceforge.net/pyserial_api.html&#34;&gt;PySerial API documentation&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Now lets look at the interesting stuff, starting with the SendStr() method.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    def SendStr(self, msg, addr=0xFFFF, options=0x01, frameid=0x00):
        return self.Send(msg.encode(&#39;utf-8&#39;), addr, options, frameid)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;SendStr()&lt;/code&gt; simply decodes the message into a bytes object using UTF-8 encoding and passes it to the &lt;code&gt;Send()&lt;/code&gt; method.  If you&amp;rsquo;re only using characters from the ascii set they will only require one byte per character.&lt;/p&gt;

&lt;p&gt;What is a bytes object?  A bytes object is basically an array of integers with values between 0-255, so literally: bytes. You can read up more on bytes and bytearrays in the &lt;a href=&#34;https://docs.python.org/3.1/library/stdtypes.html#bytes-methods&#34;&gt;Python documentation&lt;/a&gt; and &lt;a href=&#34;http://dabeaz.blogspot.com/2010/01/few-useful-bytearray-tricks.html&#34;&gt;this helpful blog post&lt;/a&gt;.  Bytes and bytearray objects are the required inputs for the PySerial library.  A bytearray is basically the same as a bytes object, except mutable.  Now lets look at the &lt;code&gt;Send()&lt;/code&gt; method.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    def Send(self, msg, addr=0xFFFF, options=0x01, frameid=0x00):
        if not msg:
            return 0

        hexs = &#39;7E 00 {:02X} 01 {:02X} {:02X} {:02X} {:02X}&#39;.format(
            len(msg) + 5,           # LSB (length)
            frameid,
            (addr &amp;amp; 0xFF00) &amp;gt;&amp;gt; 8,   # Destination address high byte
            addr &amp;amp; 0xFF,            # Destination address low byte
            options
        )

        frame = bytearray.fromhex(hexs)
        #  Append message content
        frame.extend(msg)

        # Calculate checksum byte
        frame.append(0xFF - (sum(frame[3:]) &amp;amp; 0xFF))

        # Escape any bytes containing reserved characters
        frame = self.Escape(frame)

        print(&amp;quot;Tx: &amp;quot; + self.format(frame))
        return self.serial.write(frame)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;Send()&lt;/code&gt; accepts &amp;lsquo;msg&amp;rsquo; as its first parameter, which is expected to be a bytes or bytearray object.  Optionally you can specify an address, options, or a frameid but the defaults are to broadcast, disable acknowledgments, and have no frameid.&lt;/p&gt;

&lt;p&gt;The first thing the &lt;code&gt;Send()&lt;/code&gt; method does is initialize a transmit request frame in a bytearray object.  It first formats a string that contains the desired hex characters using string formatting operations.  This isn&amp;rsquo;t the most efficient way, but it makes things more readable.  Then the bytearray &lt;code&gt;fromhex()&lt;/code&gt; method will decode the string into a bytearray object e.g. &lt;code&gt;bytearray.fromhex()&lt;/code&gt; with the strings &lt;code&gt;&amp;quot;7E 00&amp;quot;&lt;/code&gt;, &lt;code&gt;&amp;quot;7E00&amp;quot;&lt;/code&gt;, &lt;code&gt;&amp;quot; 7e00&amp;quot;&lt;/code&gt;, and &lt;code&gt;&amp;quot;7e00 &amp;quot;&lt;/code&gt; will all create a bytearray object with bytes &lt;code&gt;[0x7E, 0x00]&lt;/code&gt;.  We use this method to input our LSB, frameid, address, and options bytes (MSB is always zero).  Our LSB is equivelant to the length of our frame between the LSB and checksum or rather the length of the message contents plus 5 bytes: the API type, frameid, address, and options bytes required for a transmission request frame.&lt;/p&gt;

&lt;p&gt;Next the function extends the frame to contain our message.  Then the checksum is calculate and appended to the end.  Now that our frame is formatted, we escape any reserved characters after the start delimiter using the &lt;code&gt;Escape()&lt;/code&gt; method.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    def Escape(self, msg):
        escaped = bytearray()
        reserved = bytearray(b&amp;quot;\x7E\x7D\x11\x13&amp;quot;)

        escaped.append(msg[0])
        for m in msg[1:]:
            if m in reserved:
                escaped.append(0x7D)
                escaped.append(m ^ 0x20)
            else:
                escaped.append(m)

        return escaped
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After escaping, the message is ready to send!  The &lt;code&gt;Send()&lt;/code&gt; function prints the formatted frame for debug using the &lt;code&gt;format()&lt;/code&gt; function, and then passes it to the serial port with the PySerial &lt;code&gt;write()&lt;/code&gt; method.  The &lt;code&gt;format()&lt;/code&gt; function is just a simple function to convert a byte object into a more readable string for debug output.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    def format(self, msg):
        return &amp;quot; &amp;quot;.join(&amp;quot;{:02x}&amp;quot;.format(b) for b in msg)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here&amp;rsquo;s a breakdown of the contents of the formatted frames for the two messages in main.py:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Msg: Hello World ------------------------------------------------------------------------------
                                                                Checksum |
                                        -  &amp;quot;hello world&amp;quot; in Ascii -      |
                             Options |                                   |
                      Address LSB |  |                                   |
                   Address MSB |  |  |                                   |
                   Frame ID |  |  |  |                                   |
              Tx Request |  |  |  |  |                                   |
                  LSB |  |  |  |  |  |                                   |
               MSB |  |  |  |  |  |  |                                   |
start delimiter |  |  |  |  |  |  |  |                                   |
                |  |  |  |  |  |  |  |                                   |
                7e 00 10 01 00 ff ff 01 48 65 6c 6c 6f 20 57 6f 72 6c 64 e3


Msg: 7e 7d 11 13 5b 01 01 01 01 01 01 01 ------------------------------------------------------
                                                                           Escaped Checksum |
                                Options |                                                   |
                         Address LSB |  |                                                   |
                      Address MSB |  |  |                                                   |
                      Frame ID |  |  |  |                                                   |
                 Tx Request |  |  |  |  |                                                   |
          LSB Escaped |     |  |  |  |  |                                                   |
               MSB |  |     |  |  |  |  |                                                   |
start delimiter |  |  |     |  |  |  |  |                                                   |
                7e 00 7d 31 01 00 ff ff 01 7d 5e 7d 5d 7d 31 7d 33 5b 01 01 01 01 01 01 01 7d 5e
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So you can see, the second message is specially designed so the LSB and checksum bytes in the formatted frame require escaping, just to demonstrate that necessity (and that it works).&lt;/p&gt;

&lt;p&gt;That&amp;rsquo;s it for sending a message.  The next step is to receive the message.  This gets a bit more complicated.  When you receive through serial, it&amp;rsquo;s not guaranteed that the entire message will come through at once.  You also may get the beginning of another message.  It&amp;rsquo;s important to receive as much as possible in a call, parse out any messages, and hold onto any remaining bytes until the next time your program attempts to receive.  This is done in the example code &lt;code&gt;Receive()&lt;/code&gt; method:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    def Receive(self):
        remaining = self.serial.inWaiting()
        while remaining:
            chunk = self.serial.read(remaining)
            remaining -= len(chunk)
            self.RxBuff.extend(chunk)

        msgs = self.RxBuff.split(bytes(b&#39;\x7E&#39;))
        for msg in msgs[:-1]:
            self.Validate(msg)

        self.RxBuff = (bytearray() if self.Validate(msgs[-1]) else msgs[-1])

        if self.RxMessages:
            return self.RxMessages.popleft()
        else:
            return None
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The code first receives any data available on the serial port.  Thanks to python, we can easily &amp;lsquo;split&amp;rsquo; the buffer around the &lt;code&gt;0x7E&lt;/code&gt; start delimiter into a list of bytearrays then iterate through them.  Each call to &lt;code&gt;Validate()&lt;/code&gt; will append the message to the &lt;code&gt;RxMessages&lt;/code&gt; if the message validates.  If the last message doesn&amp;rsquo;t validate, it may be the beginning of a new message, so the method holds onto it until the next call.&lt;/p&gt;

&lt;p&gt;With this code, if you send data and call &lt;code&gt;Receive()&lt;/code&gt; immediately, the response message will not be ready in the serial buffer yet.  Python code runs much faster than the 9600 baud rate at which the serial port is operating.  Because of this it&amp;rsquo;s necessary to pause at least the minimum amount of time it takes the message to transmit, the source to process/respond, and the radio to receive/send the message back to our program.  This is why main.py sleeps for &lt;sup&gt;1&lt;/sup&gt;&amp;frasl;&lt;sub&gt;4&lt;/sub&gt; second after sending.  In production code it may be more reasonable to use callbacks or threading, but that&amp;rsquo;s beyond the scope of this tutorial; we&amp;rsquo;ll keeping it simple.  Still, there is an alternate version of XBee.py with threads and thread-safe Queues for message reception in the repository if you&amp;rsquo;re interested.
{: .notice}&lt;/p&gt;

&lt;p&gt;For each start delimiter found in the receive buffer, the &lt;code&gt;validate()&lt;/code&gt; method is called.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    def Validate(self, msg):
        # 9 bytes is Minimum length to be a valid Rx frame
        #  LSB, MSB, Type, Source Address(2), RSSI,
        #  Options, 1 byte data, checksum
        if (len(msg) - msg.count(bytes(b&#39;0x7D&#39;))) &amp;lt; 9:
            return False

        # All bytes in message must be unescaped before validating content
        frame = self.Unescape(msg)

        LSB = frame[1]
        # Frame (minus checksum) must contain at least length equal to LSB
        if LSB &amp;gt; (len(frame[2:]) - 1):
            return False

        # Validate checksum
        if (sum(frame[2:3+LSB]) &amp;amp; 0xFF) != 0xFF:
            return False

        print(&amp;quot;Rx: &amp;quot; + self.format(bytearray(b&#39;\x7E&#39;) + msg))
        self.RxMessages.append(frame)
        return True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The first thing the &lt;code&gt;Validate()&lt;/code&gt; method does is double check the message array (minus any escapes) is at least the size required for a message.  The next thing it does is undo any escape characters with the &lt;code&gt;Unescape()&lt;/code&gt; method.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    def Unescape(self, msg):
        if msg[-1] == 0x7D:
            # Last byte indicates an escape, can&#39;t unescape that
            return None

        out = bytearray()
        skip = False
        for i in range(len(msg)):
            if skip:
                skip = False
                continue

            if msg[i] == 0x7D:
                out.append(msg[i+1] ^ 0x20)
                skip = True
            else:
                out.append(msg[i])

        return out
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We need to do this before the next steps to read the LSB and checksum bytes.  Then the &lt;code&gt;Validate()&lt;/code&gt; method double checks the current frame length is at least the size indicated by the LSB.  If it is, the last step in validation is to verify the checksum by summing all characters from the LSB up to the checksum and making sure the lower byte is equal to &lt;code&gt;0xFF&lt;/code&gt;.  If all this checks out, we have a valid message!  The message is now printed for debug output and placed in the &lt;code&gt;RxMessages&lt;/code&gt; list member variable.&lt;/p&gt;

&lt;p&gt;That concludes all the example pieces to do basic message sending and receiving in API mode using Python.  Next, we&amp;rsquo;ll switch worlds into C++ code to handle message reception on an Arduino.&lt;/p&gt;

&lt;h2 id=&#34;part-three-communicating-from-an-arduino-w-api-mode:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Part Three: Communicating from an Arduino w/API mode&lt;/h2&gt;

&lt;p&gt;Now we&amp;rsquo;ll need to re-connect Falcor to our computer briefly to reset the following parameters in X-CTU:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;|        Settings for Falcor        |
| Name    | Value                   |
| :-----  | -------------------:    |
| `AP`    | `API enabled w/PPP [2]` |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now return Falcor to the 3.3v-5v breakout board but don&amp;rsquo;t wire it yet.&lt;/p&gt;

&lt;p&gt;Before wiring the Arduino to the XBee, we&amp;rsquo;ll need to load our software onto the board.  The Arduino software should recognize the Arduino.ini file, once loaded simply compile and load the program onto your board.  Once it&amp;rsquo;s programmed, disconnect the Arduino and wire the XBee to it like so:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Connect DOUT (3 from top left) to port 12 on Arduino&lt;/li&gt;
&lt;li&gt;Connect DIN (4 from top left) to port 13 on Arduino&lt;/li&gt;
&lt;li&gt;Leave 5v and GND connect as before (if you used Arudino as power source, otherwise, connect them to Arduino 5v,GND)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/xbeetut/XBeeArduinoGraphic.png&#34; alt=&#34;Passive Hello World&#34; /&gt;&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;re using pins 12, 13 as our Rx, Tx pins respectively using the SoftwareSerial library.  This frees up the default Tx,Rx pins to send debug data to our computer if you like.  This also allows you to communicate while plugged into your computer port, otherwise the Arduino serial would be occupied by the connection to your computer.  In realistic applications you would want to use a hardware serial port with its own UART.&lt;/p&gt;

&lt;p&gt;Assuming everything is plugged in, you can go back to your console from Part Two and run main.py again.  You should get an output that looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ C:/.../main.py
Tx: 7e 00 10 01 00 ff ff 01 48 65 6c 6c 6f 20 57 6f 72 6c 64 e3
Rx: 7e 00 1a 81 00 01 18 00 79 6f 75 20 73 65 6e 74 3a 20 48 65 6c 6c 6f 20 57 6f 72 6c 64 b8
Msg: you sent: Hello World
Tx: 7e 00 7d 31 01 00 ff ff 01 7d 5e 7d 5d 7d 31 7d 33 5b 01 01 01 01 01 01 FIFO 01 7d 5e
Rx: 7e 00 1b 81 00 01 1a 00 79 6f 75 20 73 65 6e 74 3a 20 7d 5e 7d 5d 7d 31 7d 33 5b 01 01 01 01 01 01 01 51
Msg: 79 6f 75 20 73 65 6e 74 3a 20 7e 7d 11 13 5b 01 01 01 01 01 01 01
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You&amp;rsquo;ll notice it&amp;rsquo;s the same content as earlier, except now our returned messages have &amp;ldquo;you sent: &amp;ldquo; appended to the front.  The Arduino is now receiving, editing, and then returning our messages.&lt;/p&gt;

&lt;p&gt;So there it is, you&amp;rsquo;ve now sent and received data in API mode with Python and Arduino.  New doors will open and bells will ring as you celebrate this wondrous day.  I&amp;rsquo;ll let you call your parents and tell them, but when you&amp;rsquo;re done let&amp;rsquo;s review the code.&lt;/p&gt;

&lt;p&gt;As before, we&amp;rsquo;ll begin with our main code in Arduino.ino.  First the setup:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;XBee xbee;
Queue RxQ;
SoftwareSerial sserial(12,13);

void setup(void)
{
    sserial.begin(9600);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We instantiate an instance of the XBee, Queue, and SoftwareSerial classes.  We&amp;rsquo;ll go more into detail on the XBee class soon.  The Queue is a C++ implementation of a standard FIFO queue for the unsigned char data type, with a couple home-brewed helper methods to aid in this application.  If that sounds unfamiliar, google &amp;ldquo;FIFO queue&amp;rdquo; and read up on them, it&amp;rsquo;s a handy data structure.  One of the most basic.  We&amp;rsquo;ll use the queue as our receive buffer.  The only code in our &lt;code&gt;setup()&lt;/code&gt; method is to start off our serial connection at 9600 baud.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;void loop(void)
{
    delay(5);
    int queueLen = 0;
    int delPos = 0;

    while (sserial.available() &amp;gt; 0){
        unsigned char in = (unsigned char)sserial.read();
        if (!RxQ.Enqueue(in)){
            break;
        }
    }

    queueLen = RxQ.Size();
    for (int i=0;i&amp;lt;queueLen;i++){
        if (RxQ.Peek(i) == 0x7E){
            unsigned char checkBuff[Q_SIZE];
            unsigned char msgBuff[Q_SIZE];
            int checkLen = 0;
            int msgLen = 0;

            checkLen = RxQ.Copy(checkBuff, i);
            msgLen = xbee.Receive(checkBuff, checkLen, msgBuff);
            if (msgLen &amp;gt; 0){
                unsigned char outMsg[Q_SIZE];
                unsigned char outFrame[Q_SIZE];
                int frameLen = 0;
                int addr = ((int)msgBuff[4] &amp;lt;&amp;lt; 8) + (int)msgBuff[5];

                // 10 is length of &amp;quot;you sent: &amp;quot;
                memcpy(outMsg, &amp;quot;you sent: &amp;quot;, 10);
                // len - (9 bytes of frame not in message content)
                memcpy(&amp;amp;outMsg[10], &amp;amp;msgBuff[8], msgLen-9);

                // 10 + (-9) = 1 more byte in new content than in previous message
                frameLen = xbee.Send(outMsg, msgLen+1, outFrame, addr);
                sserial.write(outFrame, frameLen);
                i += msgLen;
                delPos = i;
            }else{
                if (i&amp;gt;0){
                    delPos = i-1;
                }
            }
        }
    }

    RxQ.Clear(delPos);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That&amp;rsquo;s a lot to take in real quick, but don&amp;rsquo;t be too intimidated.  This is what is going on in the &lt;code&gt;loop()&lt;/code&gt; method:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;A small 5ms delay, to give the serial time to do work.&lt;/li&gt;
&lt;li&gt;Check the serial buffer for content.  If any is available, read it into the queue.&lt;/li&gt;
&lt;li&gt;Parse through the queue for a start delimiter.&lt;/li&gt;
&lt;li&gt;If a delimiter is found, check if the content after the delimiter is a proper message using &lt;code&gt;XBee.Receive()&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;If the content is valid, create a new message to send.&lt;/li&gt;
&lt;li&gt;New message is &amp;ldquo;you sent: &amp;ldquo; + content of received message.  Message is created using &lt;code&gt;XBee.Send()&lt;/code&gt; using address parsed from incoming frame, then sent using the &lt;code&gt;write()&lt;/code&gt; call to SoftwareSerial.&lt;/li&gt;
&lt;li&gt;After parsing is done the delPos variable stores off the last location of possible good/unused data in the queue, it is used to clear any unneeded contents.  We may not have received the full portion of a message yet, so we&amp;rsquo;ll hold on to any we may still want.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The code makes liberal use of buffers to keep code &amp;lsquo;simpler&amp;rsquo; as lengths vary between the data in the queue, the read message and output messages.  Algorithmically there&amp;rsquo;s definitely more efficient ways to do this, but that would be hell to read for a tutorial.  Something more eye friendly could possibly be written with other Arduino libraries such as String, but as a guy used to using C in embedded applications I stuck to what I know.  Maybe an optimization for a future version :).&lt;/p&gt;

&lt;p&gt;Now, let&amp;rsquo;s once again get to the guts of our code.  All of the main parts should look very familiar.  It&amp;rsquo;s basically carbon copies of the Python methods, except with C-friendly data structures.  I won&amp;rsquo;t add too much wordiness to the tutorial by re-explaining how things work, so I&amp;rsquo;ll just put the code here to peruse.  But just for a quick re-hash:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Receive()&lt;/code&gt; validates content to ensure it is a proper message&lt;/li&gt;
&lt;li&gt;&lt;code&gt;unescape()&lt;/code&gt; parses out escaped characters to their original content&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Send()&lt;/code&gt; Takes input content and places it into a Tx request frame (the calling method is expected to send it)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;escape()&lt;/code&gt; takes an input buffer and escapes any reserved characters.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;All XBee methods count on the calling class to provide the input and output buffers.  For all buffer sizes we&amp;rsquo;re using the Q_SIZE defined in our Queue class, since that&amp;rsquo;s the max data we&amp;rsquo;ll encounter.  The size is set to 220, a comfortable size larger than the max XBee message size of 100.  This, of course, assumes you may only receive max one 100 byte frame at a time.  This size is safe for simple applications such as this.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;int XBee::Receive(unsigned char *inBuff, int len, unsigned char *outBuff){
    int unescapeLen = 0;
    unsigned char checksum = 0;
    unsigned char LSB = 0;

    if (inBuff[0] != 0x7E)
        return 0;

    if (len &amp;lt; 10)
        return 0;

    unescapeLen = unescape(inBuff, len, outBuff);

    // Check we have at least the amount of bytes indicated by LSB
    LSB = outBuff[2];
    if (LSB &amp;gt; (unescapeLen - 4))
        return 0;

    // Calculate our checksum
    // (char will overflow, no need to AND for lower bytes)
    for (int i=3; i&amp;lt;LSB+4; i++){
        checksum += outBuff[i];
    }

    if (checksum != 0xFF)
        return 0;

    return LSB+4;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;int XBee::unescape(unsigned char *input, int inLen, unsigned char *output){
    int pos = 1;
    bool skip = false;
    unsigned char curr = 0;

    output[0] = input[0];
    for (int i=1; i&amp;lt;inLen; i++) {
        if (skip){
            skip = false;
            continue;
        }

        if (input[i] == 0x7D){
            curr = input[i+1] ^ 0x20;
            skip = true;
        }else{
            curr = input[i];
        }

        output[pos] = curr;
        pos++;
    }

    return pos;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;int XBee::Send(unsigned char *msg, int len, unsigned char *outBuff, int addr){
    unsigned char buf[100];
    int escapedLen = 0;
    unsigned char checksum = 0;

    buf[0] = 0x7E;
    buf[1] = 0x00;
    // LSB = content + 5 (content length + API type + frameid + addr(2) + options)
    buf[2] = (unsigned char)(len + 5);
    buf[3] = 0x01;  // transmit request
    buf[4] = 0x00;  // Frame ID
    buf[5] = (unsigned char)((addr &amp;amp; 0xFF00) &amp;gt;&amp;gt; 8);
    buf[6] = (unsigned char)(addr &amp;amp; 0xFF);
    buf[7] = 0x01;  // Disable acknowledge
    memcpy(&amp;amp;buf[8], msg, len);

    for (int i=3;i&amp;lt;len+8;i++){
        checksum += buf[i];
    }

    // Total length = LSB + 9 (LSB value + MSB + LSB + start delimiter + checksum)
    buf[len+8] = 0xFF - checksum;
    escapedLen = escape(buf, len+9, outBuff);

    return escapedLen;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;int XBee::escape(unsigned char *input, int inLen, unsigned char *output){
    int pos = 1;

    output[0] = input[0];
    for (int i=1; i&amp;lt;inLen; i++){
        switch(input[i]){
            case 0x7D:
            case 0x7E:
            case 0x11:
            case 0x13:
                output[pos++] = 0x7D;
                output[pos++] = input[i] ^ 0x20;
                break;
            default:
                output[pos++] = input[i];
                break;
      }
   }

   return pos;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That sums up all the main parts of the XBee example code.&lt;/p&gt;

&lt;h2 id=&#34;review:26789ce4bdeeb43961eb5aa29ffc85c8&#34;&gt;Review&lt;/h2&gt;

&lt;p&gt;That covers a basic example of programming for XBee 802.15.4 radios configured in API mode.  I found API mode very helpful when programming for my Masters thesis, which you should check out the &lt;a href=&#34;https://github.com/serdmanczyk/masters-thesis&#34;&gt;source code for&lt;/a&gt; if you would like to see an example of receiving, parsing, and sending many different API frame types in an actual application.  Hopefully this tutorial and example code enable you to get off the ground running with your application, or better understand some feature of Python, Arduino, XBee, serial communications, etc.  If you&amp;rsquo;ve encounter any trouble running the examples, or have any questions / comments / concerns please post them in the comments so others with similar problems can see too :).&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Developer Blog Begins</title>
      <link>http://serdmanczyk.github.io/BlogStarts/</link>
      <pubDate>Thu, 29 May 2014 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/BlogStarts/</guid>
      <description>&lt;p&gt;So I&amp;rsquo;ve decided to start a developer&amp;rsquo;s blog.  My first motivation in doing this was to share information on side projects as I continue to hobby in hacking/making things with electronics in my free time.  Hopefully things I do/make would inspire other people to do similar or greater things.  My second motivation is to also use it as a place to showcase software engineering side projects for others to read and build off of as well as for professional exposure.&lt;/p&gt;

&lt;p&gt;To start, I&amp;rsquo;ve blogged up an overview of the work I did on my Masters thesis in Electrical Engineering just to oil the gears.  Coming soon I am also planning posts on:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Communicating using XBee radios in API mode with Python and Arduino(C++)&lt;/li&gt;
&lt;li&gt;A basic class attendance tracking application using Python, Flask, and MongoDB&lt;/li&gt;
&lt;li&gt;A pure python implementation of k-means++ with optional equal size clusters output (pending approval)&lt;/li&gt;
&lt;li&gt;A pure Python Expectation Maximization implementation&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Good stuff is to come!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Master&#39;s Thesis</title>
      <link>http://serdmanczyk.github.io/MSEEThesis/</link>
      <pubDate>Wed, 28 May 2014 00:00:00 +0000</pubDate>
      
      <guid>http://serdmanczyk.github.io/MSEEThesis/</guid>
      <description>

&lt;h2 id=&#34;intro:87835e7e612fcf69f4ed77ed98e6b1e2&#34;&gt;Intro&lt;/h2&gt;

&lt;p&gt;Ive decided to begin blogging my various endeavors in software development and electrical engineering hackery. To kick it off, Im writing a post describing the work I did for my Masters of Science in Electrical Engineering thesis. This post will start it off with a brief introduction/overview, then Ill cover individual aspects of the project.&lt;/p&gt;

&lt;p&gt;You can read my &lt;a href=&#34;http://webpages.uncc.edu/~jmconrad/GradStudents/Thesis_Erdmanczyk.pdf&#34;&gt;full thesis&lt;/a&gt; via my advisors website, and all source code is available to view at &lt;a href=&#34;https://github.com/serdmanczyk/masters-thesis/&#34;&gt;github.com/serdmanczyk/masters-thesis/&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/msthesis/syspic.jpg&#34; alt=&#34;Snapshot of computer and all Sakura boards, all outfitted with XBee radios&#34; /&gt;&lt;/p&gt;

&lt;p&gt;The title of my thesis was Adaptive Deployment of Mobile Sensor Nodes. Unfortunately, like many academic paper titles, that comes off a bit vague. More specifically, my thesis involved researching a method for the dynamic deployment and maintenance of of mobile robots to act as a wireless tether of repeaters for radio communications between a deployed robot and its base station in restrictive environments.&lt;/p&gt;

&lt;p&gt;Thats quite a mouthful, but in reality its actually pretty simple. Lets consider an example use scenario:&lt;/p&gt;

&lt;p&gt;Consider youre deploying mobile robots into a tunnel, collapsed building, or some other environment where radio communications may become restricted due to interference from obstacles. Theres various reasons you may want to do this: data gathering, equipment maintenance, locating disaster survivors, etc.. You need a way to repeat your signal to the deployed robot, and simply beefing up your transmitter strength wont work. You could try manually placing radio repeaters, but thats not feasible in dynamic scenarios. Instead, you could deploy robots that can intelligently move themselves in positions akin to better signal strength as well as recover their tether in the case a node is damaged or destroyed. Applications like this were the aim of my thesis.&lt;/p&gt;

&lt;p&gt;Designing a system for these situations sounds super cool, and what I completed with my thesis would make a good bottom layer for one of these example applications. Unfortunately I was just one person, was completing my thesis alongside working full-time, had limited access to materials from my universities lab due to time/distance constraints, as well as had a limited personal budget, so obviously my thesis did not involve me designing and implement a full system of actual moving robots that can rescue you from a collapsed building.&lt;/p&gt;

&lt;p&gt;What I did do, was designed a piece of such a system and physically simulate it using my laptop and a few embedded boards. Other pieces required for a full system would include the parts for path navigation, collision avoidance, robot localization, pattern recognition, etc.&lt;/p&gt;

&lt;p&gt;My resulting application broke down into three hardware pieces performing three general tasks. The hardware pieces were:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;A base station run via Python. In my case a laptop, but adaptable to anything that runs python (e.g. Raspberry Pi)&lt;/li&gt;
&lt;li&gt;A tether of mobile nodes programmed in C++, implemented with &lt;a href=&#34;http://sakuraboard.net/gr-sakura_en.html&#34;&gt;Renesas Sakura&lt;/a&gt; boards (provided by my advisor), but easily adaptable to an Arduino device&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.digi.com/products/wireless-wired-embedded-solutions/zigbee-rf-modules/point-multipoint-rfmodules/xbee-series1-module&#34;&gt;XBee 802.15.4&lt;/a&gt; radios for handling wireless communications&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The three general tasks were:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The base station would dynamically deploy nodes as needed when the most recently deployed node exceeded range&lt;/li&gt;
&lt;li&gt;Deployed nodes would maintain distance between each other in order to maintain maximal signal strength&lt;/li&gt;
&lt;li&gt;In the case a node was lost, the system of nodes would maneuver and re-connect in order to heal the wireless communications tether&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I unfortunately did not get access to sufficient equipment to make the mobile nodes autonomously mobile, and instead had to simulate movement by having the Sakura boards light LEDs indicating their desired direction and then move the boards by hand. However, in my code I did provision for the output of a pulse-width-modulated signal to control a servo or DC motors.&lt;/p&gt;

&lt;p&gt;That concludes the basic, top-level overview, now let&amp;rsquo;s delve into how I handled the networking layer in my application.&lt;/p&gt;

&lt;h2 id=&#34;networking:87835e7e612fcf69f4ed77ed98e6b1e2&#34;&gt;Networking&lt;/h2&gt;

&lt;!-- EMBED: http://instagram.com/p/gZgK3NFzgv/ --&gt;

&lt;iframe src=&#34;//instagram.com/p/gZgK3NFzgv/embed/&#34; width=&#34;612&#34; height=&#34;710&#34; frameborder=&#34;0&#34; scrolling=&#34;no&#34; allowtransparency=&#34;true&#34;&gt;&lt;/iframe&gt;

&lt;p&gt;The XBee 802.15.4 nodes are called as such because they implement the low-level &lt;a href=&#34;http://en.wikipedia.org/wiki/IEEE_802.15.4&#34;&gt;802.15.4 protocol&lt;/a&gt;. This is a protocol designed for low-powered device networking, primarily embedded applications, that gives slower speeds but with lower power requirements. The 802.15.4 protocol provides accommodations for layers one and two of the &lt;a href=&#34;http://en.wikipedia.org/wiki/OSI_model&#34;&gt;OSI model&lt;/a&gt;. On layer one they handle converting the digital output to radio waves as well as direct sequence spread spectrum (DSSS) modulation to avoid radio interference. On layer two it provides Media Access Control techniques such as carrier sense multiple access with collision avoidance (CSMA/CA) to prevent radios attempting to access the communications medium at the same time. What 802.15.4 does not provide is networking, so it was up to my application to handle OSI layer three and up.&lt;/p&gt;

&lt;p&gt;Theres various ways to configure the XBee nodes to communicate, I wont expound on them here. In short, I chose to use the XBee API mode to handle communicating with the radios because of the flexibility, speed, and control it offered. I chose not to use Full Function Device / Reduced Function Device functionality, or even ZigBee, to handle networking for a slew of reasons I wont waste space divulging into here. Ill just say they were either too power hungry, had limitations too great, or just didnt fit.&lt;/p&gt;

&lt;p&gt;With XBee API mode, all messages sent and received from the radio needed to be packed in a frame format. In particular the transmission request frame would contain the following information:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;The destination node address&lt;/li&gt;
&lt;li&gt;A frame ID (used to track transmission success)&lt;/li&gt;
&lt;li&gt;Whether or not the radio should return a success packet if transmission succeeds&lt;/li&gt;
&lt;li&gt;The message itself&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The received packet would contain the following:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Source address&lt;/li&gt;
&lt;li&gt;Received signal strength indicator (RSSI) measured on message detection&lt;/li&gt;
&lt;li&gt;An optional byte to denote if message is a broadcast message&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This provided all the ingredients I needed to handle networking in-app and on-the-fly. The RSSI from the received packets is particularly interesting, as it allows the application to keep record of signal strength with nearby neighbors without additional overhead. Another good reason to use API mode, that Ill delve into in the next part.&lt;/p&gt;

&lt;p&gt;In networking, its common for devices in charge of routing to manage a table containing information and routes to known addresses. In the case of my application, networking is pretty simple: either a packet is going towards the base station or away from the base station. This kept routing tables down to two addresses: the neighbor to the front and the neighbor to the back. Of course, the base station would keep check on all nodes deployed, but would only communicate to the nearest node. For deployed nodes, the front and back neighbor are assigned by the base station on deployment.&lt;/p&gt;

&lt;p&gt;So, I have a way to address which nodes to talk to, and I have a way to route messages to all other nodes in the system. Done, right? Well, of course I had more problems.&lt;/p&gt;

&lt;p&gt;As is the nature of networking, errors will occur. Packets will be lost, so I needed a way to track specifically which packets and attempt to retry. Luckily the optional bits in the transmission frame allowed my app to track which messages had succeeded or not. If a message failed, that radio would pass a message back with a frame ID, and I would use the frame ID to retrieve the message from a short-term cache and retry. If it failed too many times, I abandoned and deleted it. This provided layer two feedback and error handling.&lt;/p&gt;

&lt;p&gt;Still, there was some trouble with multi-hop messages being lost, so the next step was to have nodes send an explicit acknowledge message for messages meant to traverse several nodes. If no acknowledge from the destination node within a specified time frame, I would retry the message, and abandon after too many retries as by then the message had probably aged.&lt;/p&gt;

&lt;p&gt;So, thats a basic overview of how I built a simple, low-level, two-way networking piece in my application. This was probably the hardest part, as this was my first time working with wireless communication and doing any explicit networking without additional software or protocol libraries. Im welcome to any feedback on what I may not have done well enough! So to review I handled networking in my application by:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Taking full control of destination and received addresses using XBee API mode&lt;/li&gt;
&lt;li&gt;Keeping a routing table in deployed nodes of the neighboring nodes to the front and back. Inwards traffic went backwards, outwards traffic went forwards.&lt;/li&gt;
&lt;li&gt;Handling errors by retry-ing packets, abandoning after too many retries.&lt;/li&gt;
&lt;li&gt;Handling lost multi-hop packets via application level acknowledgement messages: retrying after a timeout, abandoning after too many retries.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This system got packet success up to a good 95+% in scenarios with good signal strength.&lt;/p&gt;

&lt;p&gt;Now that networking is covered, our next layer to cover is using this to communicate RSSI among all of the nodes and using that to evaluate communications strength amongst the system.&lt;/p&gt;

&lt;h2 id=&#34;rss-rssi-and-syncing-measurements:87835e7e612fcf69f4ed77ed98e6b1e2&#34;&gt;RSS, RSSI, and Syncing Measurements&lt;/h2&gt;

&lt;p&gt;So, what is RSS? RSS is an acronym for &lt;a href=&#34;http://en.wikipedia.org/wiki/Signal_strength&#34;&gt;Received Signal Strength&lt;/a&gt; which is a metric used to represent how strong a radio signal is when a message is received on a listening device. In lower powered applications such as with embedded radios, it can commonly be measured as the log base 10 of the ratio of the received signal power to 1 milliwatt, aka &lt;a href=&#34;http://www.rapidtables.com/electric/dBm.htm&#34;&gt;Decibel-milliwatt&lt;/a&gt; (dBm).&lt;/p&gt;

&lt;p&gt;RSS was my chosen metric in my application because of its ease of availability via the XBee communications API mode. By monitoring the RSS of nearby nodes I could directly observe the perceived signal strength and tie it into controlling the nodes to achieve better communications strength.  This also allowed the application to automatically account for when nodes enter areas that obstruct signal strength, something that would be difficult to detect if the it attempted to control based on a distance or mapping based approach.&lt;/p&gt;

&lt;p&gt;With XBee API mode, monitoring the RSS from received messages was easy. The difficulty is, the other nodes perceived RSS may be different from our current nodes RSS due to factors such as environmental interference or other radios interfering signals. Acting on just our own measurement may cause our node to move out of our neighboring nodes effective range.&lt;/p&gt;

&lt;p&gt;To account for this, I had each node keep track of RSS to its neighbor nodes on each received packet. Every second, nodes would transfer their most recent record of perceived RSS to its neighboring node. Each would keep a running average of the 10 most recently received RSS measurements, both based on perceived strength and the neighbors reported strength. The node would act on whichever running average was weaker. The below illustration depicts this process in a friendlier visual manner.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/msthesis/RSSSync.png&#34; alt=&#34;Node RSS sync process&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Simple, right? So what about the base station? How is the base station to monitor RSS of all nodes to provide system feedback when it only communicates with the nearest node? To provide this functionality, I implemented a message to be sent from the furthest node. The first message contains the the nodes perceived RSS to its neighbor, its address, as well as the RSS reported to it. The message is passed backwards down the chain, aggregating data concerning each nodes connections and addresses as it goes. When it finally arrives at the base station, it contains information about each nodes signal strength in the chain for that snapshot in time. This process is depicted in the image below.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/msthesis/RSSReport.png&#34; alt=&#34;RSS report to base station process&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Ill point out a couple important potential criticisms. Using RSS does have some deficiency as it only represents measured signal strength, but DOES NOT represent the signal-to-noise ratio during message reception. Unfortunately, time and system constraints prevented me from facilitating the measurement of SNR, but it would be a critical piece of a deliverable system. Also, keeping a running average of the RSS is subject to some aggregation of errors, and a better option may be a running mean or some more complex filtering method.&lt;/p&gt;

&lt;p&gt;So thats how I handled monitoring and syncing signal strength between nodes in my applications system. This functionality is critical as one of the primary objectives in the system is to maintain distance between nodes in order to maximize communications strength. In my  into the primary logical functions of my system: deploying nodes as needed, maintaining distance between nodes, and healing the tether when nodes go down.&lt;/p&gt;

&lt;h2 id=&#34;node-deployment:87835e7e612fcf69f4ed77ed98e6b1e2&#34;&gt;Node Deployment&lt;/h2&gt;

&lt;p&gt;When it came to the systems responsibilities of deployment, distance management, and recovery I had to make a choice with each of how I would split that responsibility among the system parts. Should the logic for deployment be a distributed protocol among the nodes? What about healing and distance management, is that something nodes should defer to the base station? In the case of deployment, the choice of centralizing the logic to the base station was an easy one.&lt;/p&gt;

&lt;p&gt;The process I chose to handle deployment is quite simple.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Start-up process

&lt;ul&gt;
&lt;li&gt;On the Node:

&lt;ol&gt;
&lt;li&gt;After initialization, send broadcast announcing presence on one second interval&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;On the Base Station:

&lt;ol&gt;
&lt;li&gt;After initialization, listen for broadcasts from new nodes&lt;/li&gt;
&lt;li&gt;When a broadcast is heard, add node to internal list&lt;/li&gt;
&lt;li&gt;After a specified start-up interval begin deploying nodes&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Initial deployment:

&lt;ul&gt;
&lt;li&gt;Base Station:

&lt;ol&gt;
&lt;li&gt;Send message to first node assigning rear neighbor address as base stations address&lt;/li&gt;
&lt;li&gt;Send deployment message (node stops broadcasting)&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/msthesis/InitialDeployment.png&#34; alt=&#34;Initial Deployment Visualization&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Continuous deployment:

&lt;ul&gt;
&lt;li&gt;Base Station:

&lt;ol&gt;
&lt;li&gt;On an interval, check measured RSS to most recently deployed(nearest) node&lt;/li&gt;
&lt;li&gt;If RSS drops below a set threshold (determined from testing/calculations), deploy next node:&lt;/li&gt;
&lt;li&gt;Send message to recently deployed node assigning rear address as next node to be deployed&lt;/li&gt;
&lt;li&gt;Send message to newly deployed node assigning front address as recently deployed node, and rear address as base station&lt;/li&gt;
&lt;li&gt;Send deploy message to newly deployed node&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/msthesis/ContinuousDeployment.png&#34; alt=&#34;Continuous Deployment Visualization&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Of course, each assignment and deployment message is checked for an acknowledgement from the destination; if there is no acknowledgement the process bails. Further steps would be to add additional error checking on this process.&lt;/p&gt;

&lt;!-- https://www.youtube.com/watch?v=KX1XcLeSdSU --&gt;

&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;//www.youtube.com/embed/KX1XcLeSdSU&#34; frameborder=&#34;0&#34; allowfullscreen&gt;&lt;/iframe&gt;

&lt;p&gt;That sums up the deployment process, which is the simplest of the three system tasks. Now let&amp;rsquo;s go over the distance maintenance algorithm.&lt;/p&gt;

&lt;h2 id=&#34;distance-maintenance:87835e7e612fcf69f4ed77ed98e6b1e2&#34;&gt;Distance Maintenance&lt;/h2&gt;

&lt;p&gt;I chose to make the distance maintenance algorithm a distributed one. The phrase distributed algorithm tends to invoke thoughts of complexity. Implementing a distributed algorithm may require additional code to handle concurrency, error correction, message passing, etc. however in the case of my system, distributed means that I could avoid that complexity as well as increase the speed of response.&lt;/p&gt;

&lt;p&gt;My final method was actually rather simple and relied on emergent behavior.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Distance Maintenance Process:

&lt;ol&gt;
&lt;li&gt;Continually move forward&lt;/li&gt;
&lt;li&gt;If RSS to rear is too low, slow down&lt;/li&gt;
&lt;li&gt;If RSS to rear is exceptionally low, stop&lt;/li&gt;
&lt;li&gt;If RSS to front is too high, stop&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/msthesis/DistanceMaintenance.png&#34; alt=&#34;Psuedo-code and diagram&#34; /&gt;&lt;/p&gt;

&lt;p&gt;Thus the steps to implement are considerably simple. By making each nodes take these actions, the result is the tether acting as sort of a spring. If a node moves forward, it effectively pushes the node in front of it forwards as well. Each node will pull the node to the front back towards it if it goes to far. If youve ever read up on &lt;a href=&#34;http://en.wikipedia.org/wiki/Boids&#34;&gt;Boids&lt;/a&gt;, youll find this similar. I wasn&amp;rsquo;t directly inspired by the work on Boids, but I suppose you could say I was indirectly inspired because I had heard of similar things in a TED talk (which I cannot remember the name of).&lt;/p&gt;

&lt;p&gt;To compare, if I had decided to centrally control distance, it would require the base station to perform a computation on what it knows of signal strengths in the tether. Because of the work I described in part three, the base station does have this information, though it may be slightly outdated when the base station would get around to computing. The base station would also need to send at least one message down the chain to notify each node of its needed control output. This adds layers of latency and possible errors in the process, whereas by having each node process individually it doesn&amp;rsquo;t require any additional messages and causes immediate changes in control output.&lt;/p&gt;

&lt;p&gt;Unfortunately, as I mentioned earlier, I never was able to acquire materials to make the nodes truly mobile, so I had to simulate movement by lighting LEDs and moving the nodes with my hands. I did write code for an output to servo motors. Maybe sometime in the future I will acquire a series of Arduinos just to see this step, because it would be really cool to watch this be performed autonomously.&lt;/p&gt;

&lt;!-- https://www.youtube.com/watch?v=kft7dlmPVRk --&gt;

&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;//www.youtube.com/embed/kft7dlmPVRk&#34; frameborder=&#34;0&#34; allowfullscreen&gt;&lt;/iframe&gt;

&lt;p&gt;So that covers how I implemented a simple, distributed, emergent algorithm to allow the mobile nodes in the system of my thesis to control their distance to each other. Now let&amp;rsquo;s look at the final and most difficult piece: handling recovery when nodes area lost.&lt;/p&gt;

&lt;h2 id=&#34;healing-the-tether-when-nodes-are-lost:87835e7e612fcf69f4ed77ed98e6b1e2&#34;&gt;Healing the Tether when Nodes are Lost&lt;/h2&gt;

&lt;p&gt;If a node is lost, the nodes need not just to intelligently reconnect, they most likely also need to maneuver to be back in range of a healthy node. Once again there came the choice of whether to handle this distributively or centrally, and I once again chose the former.&lt;/p&gt;

&lt;p&gt;Any node in the system is expecting to hear from its neighbor to the front or rear at least once on every one second interval, so I made each node assume it had lost contact with a neighbor if it hadn&amp;rsquo;t heard anything in a small multiple of that time frame. If the neighbor was deemed lost the scenario is as follows:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;If lost neighbor to rear:

&lt;ol&gt;
&lt;li&gt;Begin to move backwards to approach remaining tether&lt;/li&gt;
&lt;li&gt;Begin sending lost broadcast message announcing its lost its rear neighbor&lt;/li&gt;
&lt;li&gt;Upon reception of acknowledgement to lost broadcast, set new neighbor as neighbor to rear&lt;/li&gt;
&lt;li&gt;Resume standard operation&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;If lost neighbor to front:

&lt;ol&gt;
&lt;li&gt;Send notification to base station (debug purposes)&lt;/li&gt;
&lt;li&gt;Continue to move forward as normal (will approach chain in front)&lt;/li&gt;
&lt;li&gt;Listen for lost broadcast&lt;/li&gt;
&lt;li&gt;Upon reception of lost broadcast send acknowledgement, set sender as front neighbor&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;http://serdmanczyk.github.io/images/msthesis/LostRecovery.png&#34; alt=&#34;Lost Node Recovery Diagram&#34; /&gt;&lt;/p&gt;

&lt;p&gt;So, with the other steps handled the way they are, handling a lost node is actually kept rather simple. The only interruption to normal movement is the node to the front of the lost node moving backwards to recover the tether, all nodes in front of that node will move backwards to follow when RSS drops (see part five). Just as distance maintenance is handled by emergent behavior as the result of a few simple steps, so is healing the tether.&lt;/p&gt;

&lt;!-- https://www.youtube.com/watch?v=btbE84ngXd8 --&gt;

&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;//www.youtube.com/embed/btbE84ngXd8&#34; frameborder=&#34;0&#34; allowfullscreen&gt;&lt;/iframe&gt;

&lt;p&gt;What about the base station? you may ask. Wont it continue to think that the tether includes the lost node because it deployed them in a certain order? Fortunately, no. If youll remember from part three, the base station receives a report from the furthest node every second containing aggregated data about each connection in the chain. If at any point the order of nodes doesn&amp;rsquo;t match the base stations record, it will update the record to match current data.&lt;/p&gt;

&lt;p&gt;That gives a general overview of how my application handles situations where a node is lost. Once again not too complicated given the other layers are designed well.&lt;/p&gt;

&lt;h2 id=&#34;summary:87835e7e612fcf69f4ed77ed98e6b1e2&#34;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Thus concludes the &amp;lsquo;blog-ification&amp;rsquo; of the work I did on my thesis.  I spared intricate details on coding and such, because that would drag on longer than I would wish for what I wanted to get across.  I will give a post soon on the basics of using API mode with XBees using Python and Arduino that will include code from this project.  Hopefully the general overview of how I implemented a system of mobile nodes/a base station to provide an automated wireless communications tether can be helpful to others with a similar project and/or may have just been entertaining to read.&lt;/p&gt;

&lt;p&gt;In summary the stages of work I did on my thesis were:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Networking - message routing and error handling&lt;/li&gt;
&lt;li&gt;Syncing RSS (signal strength) among nodes and base station.&lt;/li&gt;
&lt;li&gt;Automatically deploying new nodes from the base station&lt;/li&gt;
&lt;li&gt;Maintaining distance between nodes for optimal commmunications strength&lt;/li&gt;
&lt;li&gt;Healing the tether when a node is lost&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;A seemingly complicated task at first, made simple by splitting it up into parts and iteratively hacking away step-by-step.  Hope you enjoyed reading!&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>